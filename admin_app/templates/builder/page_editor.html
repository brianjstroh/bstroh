{% extends "base.html" %}

{% block title %}Edit: {{ page.title }} - {{ site.site_name }}{% endblock %}

{% block content %}
<div class="row">
  <!-- Component Panel -->
  <div class="col-md-3">
    <div class="card mb-4">
      <div class="card-header">
        <i class="bi bi-arrow-left"></i>
        <a href="{{ url_for('builder_dashboard') }}" class="text-decoration-none">Back to Dashboard</a>
      </div>
    </div>

    <!-- Page Settings -->
    <div class="card mb-4">
      <div class="card-header">
        <i class="bi bi-file-earmark-text"></i> Page Settings
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label small">Page Title</label>
          <input type="text" class="form-control form-control-sm" id="pageTitle" value="{{ page.title }}">
        </div>
        <div class="mb-3">
          <label class="form-label small">Meta Description</label>
          <textarea class="form-control form-control-sm" id="metaDescription" rows="2">{{ page.meta_description or '' }}</textarea>
        </div>
        {% if page.id != 'index' %}
        <hr>
        <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="showDeletePageModal()">
          <i class="bi bi-trash"></i> Delete This Page
        </button>
        {% endif %}
      </div>
    </div>

    <!-- Add Components -->
    <div class="card mb-4" id="addComponentCard">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-plus-square"></i> Add Component</span>
        <span class="badge bg-primary" id="targetSlotBadge">Main Content</span>
      </div>
      <div class="card-body p-2">
        <div class="mb-2">
          <label class="form-label small text-muted mb-1">Add to section:</label>
          <select class="form-select form-select-sm" id="componentSlot" onchange="updateSlotBadge()">
            <option value="hero">Hero Section</option>
            <option value="main" selected>Main Content</option>
            <option value="sidebar">Sidebar</option>
          </select>
        </div>
        <p class="small text-muted mb-2">Click a component to add it (hover to preview):</p>
        <div class="component-list">
          {% for component in components %}
          {% if component.category not in ['navigation', 'footer'] %}
          <div class="component-item p-2 mb-2 border rounded"
               data-component-id="{{ component.id }}"
               onclick="addComponent('{{ component.id }}')"
               onmouseenter="showComponentPreview('{{ component.id }}')"
               onmouseleave="hideComponentPreview()">
            <div class="d-flex align-items-center">
              <i class="bi bi-{{ component.thumbnail }} me-2 text-primary"></i>
              <div class="flex-grow-1">
                <div class="small fw-bold">{{ component.name }}</div>
                <div class="text-muted" style="font-size: 0.75rem;">{{ component.description[:40] }}...</div>
              </div>
              <i class="bi bi-plus-circle text-success"></i>
            </div>
          </div>
          {% endif %}
          {% endfor %}
        </div>
        <!-- Component Preview Popup -->
        <div id="componentPreviewPopup" class="component-preview-popup" style="display: none;">
          <div class="preview-header">
            <span id="previewComponentName">Component Preview</span>
          </div>
          <div class="preview-content">
            <iframe id="componentPreviewFrame" style="width: 100%; height: 200px; border: none; pointer-events: none;"></iframe>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Editor Area -->
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-layers"></i> Page Structure</span>
        <div>
          <button class="btn btn-sm btn-outline-secondary" onclick="refreshPreview()">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
          <button class="btn btn-sm btn-primary" onclick="savePage()">
            <i class="bi bi-check"></i> Save
          </button>
        </div>
      </div>
      <div class="card-body p-0">
        <!-- Slot: Hero -->
        <div class="slot-section" data-slot="hero">
          <div class="slot-header bg-light px-3 py-2 border-bottom d-flex justify-content-between align-items-center">
            <span><i class="bi bi-image"></i> Hero Section</span>
            <button class="btn btn-sm btn-outline-primary" onclick="selectSlotAndScroll('hero')" title="Add component to Hero">
              <i class="bi bi-plus"></i>
            </button>
          </div>
          <div class="slot-content p-2" id="slot-hero">
          </div>
        </div>

        <!-- Slot: Main -->
        <div class="slot-section" data-slot="main">
          <div class="slot-header bg-light px-3 py-2 border-bottom d-flex justify-content-between align-items-center">
            <span><i class="bi bi-layout-text-window"></i> Main Content</span>
            <button class="btn btn-sm btn-outline-primary" onclick="selectSlotAndScroll('main')" title="Add component to Main">
              <i class="bi bi-plus"></i>
            </button>
          </div>
          <div class="slot-content p-2" id="slot-main">
          </div>
        </div>

        <!-- Slot: Sidebar -->
        <div class="slot-section" data-slot="sidebar">
          <div class="slot-header bg-light px-3 py-2 border-bottom d-flex justify-content-between align-items-center">
            <span><i class="bi bi-layout-sidebar"></i> Sidebar</span>
            <button class="btn btn-sm btn-outline-primary" onclick="selectSlotAndScroll('sidebar')" title="Add component to Sidebar">
              <i class="bi bi-plus"></i>
            </button>
          </div>
          <div class="slot-content p-2" id="slot-sidebar">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Panel -->
  <div class="col-md-3">
    <div class="card" style="position: sticky; top: 1rem;">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-eye"></i> Preview</span>
        <a href="https://{{ domain }}/{{ page.id }}.html" target="_blank" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-box-arrow-up-right"></i>
        </a>
      </div>
      <div class="card-body p-0">
        <iframe id="previewFrame" src="{{ url_for('builder_preview', page_id=page.id) }}"
                style="width: 100%; height: 500px; border: none; transform-origin: top left; transform: scale(0.5); width: 200%; height: 1000px;">
        </iframe>
      </div>
    </div>
  </div>
</div>

<!-- Edit Component Modal -->
<div class="modal fade" id="editComponentModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Component</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="editComponentBody">
        <!-- Dynamic form fields -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger me-auto" onclick="deleteCurrentComponent()">
          <i class="bi bi-trash"></i> Delete
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveComponentEdits()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Page Confirmation Modal -->
<div class="modal fade" id="deletePageModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Delete Page</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the page "<strong>{{ page.title }}</strong>"?</p>
        <p class="text-danger mb-0"><i class="bi bi-exclamation-circle"></i> This action is permanent and cannot be undone. The page and all its content will be permanently deleted.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="deletePage()">
          <i class="bi bi-trash"></i> Delete Permanently
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Image Browser Modal -->
<div class="modal fade" id="imageBrowserModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-images"></i> Select Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Upload Section -->
        <div class="mb-4">
          <div class="upload-dropzone p-4 border rounded text-center" id="imageDropzone">
            <i class="bi bi-cloud-upload fs-1 text-muted"></i>
            <p class="mb-2">Drag & drop an image here, or click to browse</p>
            <input type="file" id="imageUploadInput" accept="image/*" style="display: none;">
            <button class="btn btn-primary" onclick="document.getElementById('imageUploadInput').click()">
              <i class="bi bi-upload"></i> Upload Image
            </button>
          </div>
          <div id="uploadProgress" class="mt-2" style="display: none;">
            <div class="progress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
            </div>
            <small class="text-muted">Uploading...</small>
          </div>
        </div>

        <!-- Existing Images Grid -->
        <h6 class="mb-3">Existing Images</h6>
        <div id="imageGrid" class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-2">
          <div class="col text-center text-muted py-4">
            <i class="bi bi-hourglass-split"></i> Loading...
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <span id="imageListModeHint" class="text-muted small me-auto" style="display: none;">
          <i class="bi bi-info-circle"></i> Click images to add them to gallery
        </span>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <span id="imageBrowserCancelText">Cancel</span>
          <span id="imageBrowserDoneText" style="display: none;">Done</span>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .component-item {
    cursor: pointer;
    transition: all 0.2s;
    border-color: #dee2e6 !important;
  }
  .component-item:hover {
    background-color: #e7f1ff;
    border-color: #0d6efd !important;
    transform: translateX(4px);
  }
  .component-item:hover .bi-plus-circle {
    transform: scale(1.2);
  }
  .component-item .bi-plus-circle {
    transition: transform 0.2s;
  }

  /* Component Preview Popup */
  .component-preview-popup {
    position: absolute;
    left: 105%;
    top: 0;
    width: 350px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    overflow: hidden;
  }
  .component-preview-popup .preview-header {
    background: #f8f9fa;
    padding: 8px 12px;
    border-bottom: 1px solid #dee2e6;
    font-weight: 500;
    font-size: 0.875rem;
  }
  .component-preview-popup .preview-content {
    background: #f0f0f0;
    padding: 8px;
  }
  .component-preview-popup .preview-content iframe {
    background: white;
    border-radius: 4px;
  }

  /* Position the component list container as relative for popup positioning */
  .component-list {
    position: relative;
  }

  .slot-content {
    min-height: 60px;
    background: #fafafa;
  }

  .slot-content:empty::after {
    content: 'Drop components here';
    display: block;
    padding: 1rem;
    text-align: center;
    color: #aaa;
    font-style: italic;
  }

  .page-component {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    cursor: move;
    transition: all 0.2s;
  }

  .page-component:hover {
    border-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .page-component.dragging {
    opacity: 0.5;
  }

  .page-component .component-actions {
    opacity: 0;
    transition: opacity 0.2s;
  }

  .page-component:hover .component-actions {
    opacity: 1;
  }

  .drag-over {
    border: 2px dashed #0d6efd;
    background: #e7f1ff;
  }

  /* Image Browser Styles */
  .upload-dropzone {
    border: 2px dashed #dee2e6;
    background: #f8f9fa;
    transition: all 0.2s;
  }
  .upload-dropzone:hover, .upload-dropzone.drag-over {
    border-color: #0d6efd;
    background: #e7f1ff;
  }
  .image-thumb {
    cursor: pointer;
    border: 2px solid transparent;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.2s;
    aspect-ratio: 1;
  }
  .image-thumb:hover {
    border-color: #0d6efd;
    transform: scale(1.05);
  }
  .image-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .image-thumb .image-name {
    font-size: 0.7rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding: 4px;
    background: rgba(0,0,0,0.7);
    color: white;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
  }
  .image-preview-container {
    position: relative;
    width: 60px;
    height: 60px;
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid #dee2e6;
  }
  .image-preview-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Image List Styles (for gallery component) */
  .imagelist-container .row {
    min-height: 80px;
  }
  .imagelist-container .image-thumb {
    width: 100%;
    height: 80px;
    background: #f8f9fa;
  }
  .imagelist-container .image-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .imagelist-container .row:empty::after {
    content: 'No images yet. Click "Add Images" to add some.';
    display: block;
    padding: 1rem;
    text-align: center;
    color: #aaa;
    font-style: italic;
    width: 100%;
  }
</style>

<script>
  const pageId = '{{ page.id }}';
  let pageData = {{ page | tojson | safe }};
  let componentsLib = {{ components | tojson | safe }};
  let editModal;
  let deletePageModal;
  let currentEditingComponent = null;
  let currentEditingSlot = null;
  let currentEditingIndex = null;

  document.addEventListener('DOMContentLoaded', function() {
    editModal = new bootstrap.Modal(document.getElementById('editComponentModal'));
    deletePageModal = new bootstrap.Modal(document.getElementById('deletePageModal'));
    renderAllSlots();
    initDragAndDrop();
    initImageBrowser();
    // Note: Don't call refreshPreview() here - the iframe loads via its src attribute initially
    // refreshPreview() is called when user makes changes to trigger live preview updates
  });

  function showDeletePageModal() {
    deletePageModal.show();
  }

  async function deletePage() {
    try {
      const response = await fetch(`/builder/pages/${pageId}/delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const data = await response.json();

      if (data.success) {
        window.location.href = '/builder';
      } else {
        alert('Error deleting page: ' + data.error);
        deletePageModal.hide();
      }
    } catch (error) {
      alert('Error deleting page: ' + error.message);
      deletePageModal.hide();
    }
  }

  function renderAllSlots() {
    const slots = ['hero', 'main', 'sidebar'];
    slots.forEach(slot => {
      renderSlot(slot);
    });
  }

  function renderSlot(slotName) {
    const container = document.getElementById('slot-' + slotName);
    const components = pageData.slots[slotName] || [];

    container.innerHTML = '';

    components.forEach((comp, index) => {
      const compDef = componentsLib.find(c => c.id === comp.type);
      const compName = compDef ? compDef.name : comp.type;

      const div = document.createElement('div');
      div.className = 'page-component';
      div.draggable = true;
      div.dataset.slot = slotName;
      div.dataset.index = index;

      div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <i class="bi bi-grip-vertical text-muted me-2"></i>
            <strong>${compName}</strong>
            <span class="text-muted small ms-2">${getComponentPreview(comp)}</span>
          </div>
          <div class="component-actions">
            <button class="btn btn-sm btn-outline-primary" onclick="editComponent('${slotName}', ${index})">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="removeComponent('${slotName}', ${index})">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      `;

      container.appendChild(div);
    });
  }

  function getComponentPreview(comp) {
    if (comp.data.title) return comp.data.title.substring(0, 30) + (comp.data.title.length > 30 ? '...' : '');
    if (comp.data.heading) return comp.data.heading.substring(0, 30) + (comp.data.heading.length > 30 ? '...' : '');
    if (comp.data.site_name) return comp.data.site_name;
    return '';
  }

  const slotNames = {
    hero: 'Hero Section',
    main: 'Main Content',
    sidebar: 'Sidebar'
  };

  function updateSlotBadge() {
    const slot = document.getElementById('componentSlot').value;
    document.getElementById('targetSlotBadge').textContent = slotNames[slot] || slot;
  }

  function selectSlotAndScroll(slotName) {
    // Update the dropdown
    document.getElementById('componentSlot').value = slotName;
    updateSlotBadge();

    // Scroll to and highlight the component panel
    const addCard = document.getElementById('addComponentCard');
    addCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    addCard.classList.add('border-primary');
    setTimeout(() => addCard.classList.remove('border-primary'), 2000);
  }

  function showToast(message, type = 'success') {
    // Create toast container if it doesn't exist
    let container = document.getElementById('toastContainer');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toastContainer';
      container.className = 'position-fixed bottom-0 end-0 p-3';
      container.style.zIndex = '1100';
      document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0 show`;
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
      </div>
    `;
    container.appendChild(toast);

    setTimeout(() => toast.remove(), 3000);
  }

  // Component preview on hover
  let previewTimeout = null;

  function showComponentPreview(componentId) {
    // Small delay to avoid flickering
    previewTimeout = setTimeout(async () => {
      const compDef = componentsLib.find(c => c.id === componentId);
      if (!compDef) return;

      const popup = document.getElementById('componentPreviewPopup');
      const nameEl = document.getElementById('previewComponentName');
      const iframe = document.getElementById('componentPreviewFrame');

      nameEl.textContent = compDef.name;

      // Fetch component preview
      try {
        const response = await fetch('/builder/component/preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            component_type: componentId,
            component_data: compDef.default_data
          })
        });

        const data = await response.json();
        if (data.success) {
          iframe.srcdoc = data.html;
        }
      } catch (error) {
        console.error('Preview error:', error);
      }

      popup.style.display = 'block';
    }, 200);
  }

  function hideComponentPreview() {
    if (previewTimeout) {
      clearTimeout(previewTimeout);
      previewTimeout = null;
    }
    document.getElementById('componentPreviewPopup').style.display = 'none';
  }

  function addComponent(componentId) {
    hideComponentPreview(); // Hide preview when adding
    const slot = document.getElementById('componentSlot').value;
    const compDef = componentsLib.find(c => c.id === componentId);

    if (!compDef) {
      showToast('Component not found', 'danger');
      return;
    }

    // Generate unique id for the component
    const compId = 'comp-' + Date.now();

    const newComponent = {
      id: compId,
      type: componentId,
      data: JSON.parse(JSON.stringify(compDef.default_data))
    };

    if (!pageData.slots[slot]) {
      pageData.slots[slot] = [];
    }

    pageData.slots[slot].push(newComponent);
    renderSlot(slot);
    refreshPreview();

    // Show success feedback
    showToast(`Added "${compDef.name}" to ${slotNames[slot]}`);

    // Highlight the slot where component was added
    const slotEl = document.getElementById('slot-' + slot);
    slotEl.classList.add('bg-success-subtle');
    setTimeout(() => slotEl.classList.remove('bg-success-subtle'), 1000);
  }

  function editComponent(slotName, index) {
    currentEditingSlot = slotName;
    currentEditingIndex = index;
    currentEditingComponent = pageData.slots[slotName][index];

    const compDef = componentsLib.find(c => c.id === currentEditingComponent.type);
    if (!compDef) {
      alert('Component definition not found');
      return;
    }

    document.querySelector('#editComponentModal .modal-title').textContent = 'Edit ' + compDef.name;

    const body = document.getElementById('editComponentBody');
    body.innerHTML = '';

    compDef.editable_fields.forEach(field => {
      const value = currentEditingComponent.data[field.name] || field.default || '';
      body.appendChild(createFieldEditor(field, value));
    });

    editModal.show();
  }

  function createFieldEditor(field, value) {
    const div = document.createElement('div');
    div.className = 'mb-3';

    const label = document.createElement('label');
    label.className = 'form-label';
    label.textContent = field.label;
    div.appendChild(label);

    let input;

    switch (field.type) {
      case 'textarea':
      case 'richtext':
        input = document.createElement('textarea');
        input.className = 'form-control';
        input.rows = 4;
        input.value = value;
        break;

      case 'select':
        input = document.createElement('select');
        input.className = 'form-select';
        (field.options || []).forEach(opt => {
          const option = document.createElement('option');
          // Handle both string options and {value, label} objects
          const optValue = typeof opt === 'string' ? opt : opt.value;
          const optLabel = typeof opt === 'string' ? opt : opt.label;
          option.value = optValue;
          option.textContent = optLabel;
          option.selected = optValue === value;
          input.appendChild(option);
        });
        break;

      case 'image':
        // Container for preview + input
        const imageContainer = document.createElement('div');
        imageContainer.className = 'd-flex gap-3 align-items-start';

        // Preview thumbnail
        const previewContainer = document.createElement('div');
        previewContainer.className = 'image-preview-container';
        const previewImg = document.createElement('img');
        previewImg.src = value || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60"><rect fill="%23f0f0f0" width="60" height="60"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23999" font-size="10">No image</text></svg>';
        previewImg.alt = 'Preview';
        previewImg.onerror = () => {
          previewImg.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60"><rect fill="%23f0f0f0" width="60" height="60"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23999" font-size="10">No image</text></svg>';
        };
        previewContainer.appendChild(previewImg);
        imageContainer.appendChild(previewContainer);

        // Input and buttons wrapper
        const inputWrapper = document.createElement('div');
        inputWrapper.className = 'flex-grow-1';

        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';

        input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control';
        input.value = value;
        input.placeholder = 'Image URL or click Browse';
        input.onchange = () => {
          previewImg.src = input.value || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60"><rect fill="%23f0f0f0" width="60" height="60"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23999" font-size="10">No image</text></svg>';
        };

        // Browse button - opens image browser modal
        const browseBtn = document.createElement('button');
        browseBtn.type = 'button';
        browseBtn.className = 'btn btn-outline-primary';
        browseBtn.innerHTML = '<i class="bi bi-images"></i> Browse';
        browseBtn.title = 'Browse existing images';
        browseBtn.onclick = () => openImageBrowser(input, previewImg);

        // Upload button - quick upload
        const uploadBtn = document.createElement('button');
        uploadBtn.type = 'button';
        uploadBtn.className = 'btn btn-outline-secondary';
        uploadBtn.innerHTML = '<i class="bi bi-upload"></i>';
        uploadBtn.title = 'Upload new image';
        uploadBtn.onclick = () => {
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = 'image/*';
          fileInput.onchange = async (e) => {
            if (e.target.files[0]) {
              await uploadImageFile(e.target.files[0], input, previewImg);
            }
          };
          fileInput.click();
        };

        inputGroup.appendChild(input);
        inputGroup.appendChild(browseBtn);
        inputGroup.appendChild(uploadBtn);
        inputWrapper.appendChild(inputGroup);

        // Help text
        const helpText = document.createElement('small');
        helpText.className = 'text-muted';
        helpText.textContent = 'Browse existing images or upload a new one';
        inputWrapper.appendChild(helpText);

        imageContainer.appendChild(inputWrapper);
        div.appendChild(imageContainer);
        input.dataset.fieldKey = field.name;
        return div;

      case 'color':
        input = document.createElement('input');
        input.type = 'color';
        input.className = 'form-control form-control-color';
        input.value = value || '#000000';
        break;

      case 'checkbox':
        input = document.createElement('input');
        input.type = 'checkbox';
        input.className = 'form-check-input';
        input.checked = value === true || value === 'true';
        const checkDiv = document.createElement('div');
        checkDiv.className = 'form-check';
        checkDiv.appendChild(input);
        const checkLabel = document.createElement('label');
        checkLabel.className = 'form-check-label';
        checkLabel.textContent = field.label;
        checkDiv.appendChild(checkLabel);
        div.innerHTML = '';
        div.appendChild(checkDiv);
        input.dataset.fieldKey = field.name;
        return div;

      case 'imagelist':
        // Multi-image selector for galleries
        const imageListContainer = document.createElement('div');
        imageListContainer.className = 'imagelist-container';
        imageListContainer.dataset.fieldKey = field.name;

        // Grid of current images
        const imageListGrid = document.createElement('div');
        imageListGrid.className = 'row row-cols-4 g-2 mb-2';

        const imageList = Array.isArray(value) ? value : [];
        imageList.forEach((imgUrl, idx) => {
          imageListGrid.appendChild(createImageListItem(imgUrl, idx, imageListGrid, imageListContainer));
        });
        imageListContainer.appendChild(imageListGrid);

        // Add image button
        const addImageBtn = document.createElement('button');
        addImageBtn.type = 'button';
        addImageBtn.className = 'btn btn-outline-primary';
        addImageBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Add Images';
        addImageBtn.onclick = () => openImageBrowserForList(imageListGrid, imageListContainer);
        imageListContainer.appendChild(addImageBtn);

        div.appendChild(imageListContainer);
        return div;

      case 'array':
        const arrayContainer = document.createElement('div');
        arrayContainer.className = 'array-field-container';
        arrayContainer.dataset.fieldKey = field.name;

        const items = Array.isArray(value) ? value : [];
        items.forEach((item, idx) => {
          arrayContainer.appendChild(createArrayItemEditor(field, item, idx));
        });

        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'btn btn-sm btn-outline-primary mt-2';
        addBtn.innerHTML = '<i class="bi bi-plus"></i> Add Item';
        addBtn.onclick = () => {
          const newItem = {};
          (field.item_fields || []).forEach(f => {
            newItem[f.key] = f.default || '';
          });
          const newEl = createArrayItemEditor(field, newItem, arrayContainer.querySelectorAll('.array-item').length);
          arrayContainer.insertBefore(newEl, addBtn);
        };
        arrayContainer.appendChild(addBtn);

        div.appendChild(arrayContainer);
        return div;

      default:
        input = document.createElement('input');
        input.type = field.type === 'url' ? 'url' : 'text';
        input.className = 'form-control';
        input.value = value;
    }

    input.dataset.fieldKey = field.name;
    div.appendChild(input);
    return div;
  }

  function createArrayItemEditor(field, item, index) {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'array-item border rounded p-2 mb-2';
    itemDiv.dataset.index = index;

    const header = document.createElement('div');
    header.className = 'd-flex justify-content-between align-items-center mb-2';
    header.innerHTML = `
      <span class="small text-muted">Item ${index + 1}</span>
      <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.array-item').remove()">
        <i class="bi bi-x"></i>
      </button>
    `;
    itemDiv.appendChild(header);

    (field.item_fields || []).forEach(subField => {
      const subDiv = document.createElement('div');
      subDiv.className = 'mb-2';

      const subLabel = document.createElement('label');
      subLabel.className = 'form-label small';
      subLabel.textContent = subField.label;
      subDiv.appendChild(subLabel);

      const subInput = document.createElement('input');
      subInput.type = 'text';
      subInput.className = 'form-control form-control-sm';
      subInput.value = item[subField.key] || '';
      subInput.dataset.subFieldKey = subField.key;
      subDiv.appendChild(subInput);

      itemDiv.appendChild(subDiv);
    });

    return itemDiv;
  }

  function saveComponentEdits() {
    const body = document.getElementById('editComponentBody');

    // Regular fields (exclude containers that are handled separately)
    body.querySelectorAll('[data-field-key]:not(.imagelist-container):not(.array-field-container)').forEach(input => {
      const key = input.dataset.fieldKey;
      if (input.type === 'checkbox') {
        currentEditingComponent.data[key] = input.checked;
      } else {
        currentEditingComponent.data[key] = input.value;
      }
    });

    // Image list fields (for gallery component)
    body.querySelectorAll('.imagelist-container').forEach(container => {
      const key = container.dataset.fieldKey;
      const images = [];
      container.querySelectorAll('.image-thumb[data-image-url]').forEach(thumb => {
        images.push(thumb.dataset.imageUrl);
      });
      currentEditingComponent.data[key] = images;
    });

    // Array fields
    body.querySelectorAll('.array-field-container').forEach(container => {
      const key = container.dataset.fieldKey;
      const items = [];
      container.querySelectorAll('.array-item').forEach(itemEl => {
        const item = {};
        itemEl.querySelectorAll('[data-sub-field-key]').forEach(input => {
          item[input.dataset.subFieldKey] = input.value;
        });
        if (Object.keys(item).length > 0) {
          items.push(item);
        }
      });
      currentEditingComponent.data[key] = items;
    });

    pageData.slots[currentEditingSlot][currentEditingIndex] = currentEditingComponent;
    renderSlot(currentEditingSlot);
    refreshPreview();
    editModal.hide();
    showToast('Component updated');
  }

  function deleteCurrentComponent() {
    if (confirm('Are you sure you want to delete this component?')) {
      pageData.slots[currentEditingSlot].splice(currentEditingIndex, 1);
      renderSlot(currentEditingSlot);
      refreshPreview();
      editModal.hide();
    }
  }

  function removeComponent(slotName, index) {
    if (confirm('Remove this component?')) {
      pageData.slots[slotName].splice(index, 1);
      renderSlot(slotName);
      refreshPreview();
    }
  }

  function initDragAndDrop() {
    document.querySelectorAll('.slot-content').forEach(slot => {
      slot.addEventListener('dragover', handleDragOver);
      slot.addEventListener('drop', handleDrop);
      slot.addEventListener('dragleave', handleDragLeave);
    });

    document.addEventListener('dragstart', handleDragStart);
    document.addEventListener('dragend', handleDragEnd);
  }

  let draggedElement = null;
  let draggedSlot = null;
  let draggedIndex = null;

  function handleDragStart(e) {
    if (!e.target.classList.contains('page-component')) return;
    draggedElement = e.target;
    draggedSlot = e.target.dataset.slot;
    draggedIndex = parseInt(e.target.dataset.index);
    e.target.classList.add('dragging');
  }

  function handleDragEnd(e) {
    if (!e.target.classList.contains('page-component')) return;
    e.target.classList.remove('dragging');
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
  }

  function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
  }

  function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
  }

  function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');

    if (!draggedElement) return;

    const targetSlot = e.currentTarget.id.replace('slot-', '');

    // Remove from old position
    const component = pageData.slots[draggedSlot].splice(draggedIndex, 1)[0];

    // Determine target index
    let targetIndex = pageData.slots[targetSlot]?.length || 0;
    const targetComponent = e.target.closest('.page-component');
    if (targetComponent) {
      targetIndex = parseInt(targetComponent.dataset.index);
      if (draggedSlot === targetSlot && draggedIndex < targetIndex) {
        targetIndex--;
      }
    }

    // Add to new position
    if (!pageData.slots[targetSlot]) {
      pageData.slots[targetSlot] = [];
    }
    pageData.slots[targetSlot].splice(targetIndex, 0, component);

    renderSlot(draggedSlot);
    if (draggedSlot !== targetSlot) {
      renderSlot(targetSlot);
    }
    refreshPreview();

    draggedElement = null;
    draggedSlot = null;
    draggedIndex = null;
  }

  // Image Browser Functions
  let imageBrowserModal;
  let currentImageInput = null;
  let currentImagePreview = null;

  function initImageBrowser() {
    imageBrowserModal = new bootstrap.Modal(document.getElementById('imageBrowserModal'));

    // Setup drag & drop on dropzone
    const dropzone = document.getElementById('imageDropzone');
    const fileInput = document.getElementById('imageUploadInput');

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('drag-over');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('drag-over');
    });

    dropzone.addEventListener('drop', async (e) => {
      e.preventDefault();
      dropzone.classList.remove('drag-over');
      if (e.dataTransfer.files.length > 0) {
        await uploadImageFromBrowser(e.dataTransfer.files[0]);
      }
    });

    fileInput.addEventListener('change', async (e) => {
      if (e.target.files.length > 0) {
        await uploadImageFromBrowser(e.target.files[0]);
        e.target.value = ''; // Reset for next upload
      }
    });
  }

  async function openImageBrowser(inputElement, previewElement) {
    currentImageInput = inputElement;
    currentImagePreview = previewElement;

    // Load existing images
    await loadImageGrid();

    imageBrowserModal.show();
  }

  async function loadImageGrid() {
    const grid = document.getElementById('imageGrid');
    grid.innerHTML = '<div class="col-12 text-center text-muted py-4"><i class="bi bi-hourglass-split"></i> Loading...</div>';

    try {
      const response = await fetch('/builder/assets');
      const data = await response.json();

      if (data.images && data.images.length > 0) {
        grid.innerHTML = '';
        data.images.forEach(img => {
          const col = document.createElement('div');
          col.className = 'col';

          const thumb = document.createElement('div');
          thumb.className = 'image-thumb position-relative';
          // Use full_url for both preview and storage to ensure it works in srcdoc iframe
          thumb.onclick = () => selectImage(img.full_url);

          const imgEl = document.createElement('img');
          imgEl.src = img.full_url;
          imgEl.alt = img.name;
          imgEl.loading = 'lazy';

          const nameEl = document.createElement('div');
          nameEl.className = 'image-name';
          nameEl.textContent = img.name;

          thumb.appendChild(imgEl);
          thumb.appendChild(nameEl);
          col.appendChild(thumb);
          grid.appendChild(col);
        });
      } else {
        grid.innerHTML = '<div class="col-12 text-center text-muted py-4"><i class="bi bi-image"></i> No images found. Upload one above!</div>';
      }
    } catch (error) {
      grid.innerHTML = '<div class="col-12 text-center text-danger py-4"><i class="bi bi-exclamation-triangle"></i> Error loading images</div>';
      console.error('Error loading images:', error);
    }
  }

  function selectImage(url) {
    if (currentImageInput) {
      currentImageInput.value = url;
      if (currentImagePreview) {
        currentImagePreview.src = url;
      }
    }
    imageBrowserModal.hide();
    showToast('Image selected');
  }

  async function uploadImageFromBrowser(file) {
    // Validate
    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
    if (!validTypes.includes(file.type)) {
      showToast('Invalid file type. Use JPG, PNG, GIF, WebP, or SVG.', 'danger');
      return;
    }

    const progress = document.getElementById('uploadProgress');
    progress.style.display = 'block';

    try {
      const formData = new FormData();
      formData.append('file', file);

      const response = await fetch('/builder/assets/upload', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        showToast('Image uploaded successfully');
        // Reload the grid to show the new image
        await loadImageGrid();
        // Select the newly uploaded image (handles both single and list modes)
        selectImage(data.url);
      } else {
        showToast('Upload failed: ' + data.error, 'danger');
      }
    } catch (error) {
      showToast('Upload error: ' + error.message, 'danger');
    } finally {
      progress.style.display = 'none';
    }
  }

  // Image List Functions for Gallery Component
  let currentImageListGrid = null;
  let currentImageListContainer = null;

  function createImageListItem(imgUrl, idx, gridElement, containerElement) {
    const col = document.createElement('div');
    col.className = 'col';
    col.dataset.imageIndex = idx;

    const thumb = document.createElement('div');
    thumb.className = 'image-thumb position-relative';
    thumb.style.aspectRatio = '1';

    const imgEl = document.createElement('img');
    // URLs should already be full URLs (https://domain/...)
    imgEl.src = imgUrl;
    imgEl.alt = `Gallery image ${idx + 1}`;
    imgEl.loading = 'lazy';
    imgEl.onerror = () => {
      imgEl.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect fill="%23f0f0f0" width="80" height="80"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23999" font-size="10">Error</text></svg>';
    };

    // Store the full URL
    thumb.dataset.imageUrl = imgUrl;

    // Delete button overlay
    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'btn btn-sm btn-danger position-absolute';
    deleteBtn.style.cssText = 'top: 4px; right: 4px; padding: 2px 6px; font-size: 0.7rem;';
    deleteBtn.innerHTML = '<i class="bi bi-x"></i>';
    deleteBtn.onclick = (e) => {
      e.stopPropagation();
      col.remove();
      // Re-index remaining items
      gridElement.querySelectorAll('[data-image-index]').forEach((item, newIdx) => {
        item.dataset.imageIndex = newIdx;
      });
    };

    thumb.appendChild(imgEl);
    thumb.appendChild(deleteBtn);
    col.appendChild(thumb);

    return col;
  }

  function openImageBrowserForList(gridElement, containerElement) {
    currentImageListGrid = gridElement;
    currentImageListContainer = containerElement;

    // Set a flag to indicate we're in multi-select mode
    imageBrowserModal._isListMode = true;

    // Update UI for list mode
    document.getElementById('imageListModeHint').style.display = 'inline';
    document.getElementById('imageBrowserCancelText').style.display = 'none';
    document.getElementById('imageBrowserDoneText').style.display = 'inline';

    loadImageGrid();
    imageBrowserModal.show();
  }

  function selectImageForList(url) {
    if (currentImageListGrid && currentImageListContainer) {
      const existingCount = currentImageListGrid.querySelectorAll('[data-image-index]').length;
      const newItem = createImageListItem(url, existingCount, currentImageListGrid, currentImageListContainer);
      currentImageListGrid.appendChild(newItem);
      showToast('Image added to gallery');
    }
    // Don't close modal - allow adding multiple images
  }

  // Override selectImage to check if we're in list mode
  const originalSelectImage = selectImage;
  selectImage = function(url) {
    if (imageBrowserModal._isListMode) {
      selectImageForList(url);
    } else {
      originalSelectImage(url);
    }
  };

  // Reset list mode when modal is hidden
  document.getElementById('imageBrowserModal').addEventListener('hidden.bs.modal', function() {
    imageBrowserModal._isListMode = false;
    currentImageListGrid = null;
    currentImageListContainer = null;

    // Reset UI
    document.getElementById('imageListModeHint').style.display = 'none';
    document.getElementById('imageBrowserCancelText').style.display = 'inline';
    document.getElementById('imageBrowserDoneText').style.display = 'none';
  });

  async function uploadImageFile(file, inputElement, previewElement) {
    // Validate
    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
    if (!validTypes.includes(file.type)) {
      showToast('Invalid file type. Use JPG, PNG, GIF, WebP, or SVG.', 'danger');
      return;
    }

    try {
      const formData = new FormData();
      formData.append('file', file);

      const response = await fetch('/builder/assets/upload', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        inputElement.value = data.url;
        if (previewElement) {
          previewElement.src = data.url;
        }
        showToast('Image uploaded');
      } else {
        showToast('Upload failed: ' + data.error, 'danger');
      }
    } catch (error) {
      showToast('Upload error: ' + error.message, 'danger');
    }
  }

  async function savePage() {
    // Update page settings
    pageData.title = document.getElementById('pageTitle').value;
    pageData.meta_description = document.getElementById('metaDescription').value;

    try {
      const response = await fetch(`/builder/pages/${pageId}/save`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(pageData)
      });

      const data = await response.json();

      if (data.success) {
        // Refresh preview to show published version
        refreshPreview();
        alert('Page saved and published!');
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      alert('Error saving page: ' + error.message);
    }
  }

  async function refreshPreview() {
    const frame = document.getElementById('previewFrame');

    try {
      // POST current unsaved page data to get live preview
      const response = await fetch(`/builder/preview/${pageId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(pageData)
      });

      if (response.ok) {
        const html = await response.text();
        // Use srcdoc to display the preview without saving
        frame.srcdoc = html;
      } else {
        console.error('Preview failed:', response.status);
      }
    } catch (error) {
      console.error('Preview error:', error);
    }
  }
</script>
{% endblock %}
