{% extends "base.html" %}

{% block title %}Edit: {{ page.title }} - {{ site.site_name }}{% endblock %}

{% block content %}
<!-- Leaflet CSS/JS for map editor -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

{# Apply site theme colors to the editor #}
{% set current_scheme = none %}
{% for scheme in color_schemes %}
  {% if scheme.id == site.color_scheme_id %}
    {% set current_scheme = scheme %}
  {% endif %}
{% endfor %}
{% if current_scheme %}
{% set colors = current_scheme.colors.copy() %}
{% for key, val in (site.color_overrides or {}).items() %}
  {% set _ = colors.update({key: val}) %}
{% endfor %}
<style>
  /* Site theme applied to editor */
  :root {
    --site-primary: {{ colors.primary or '#0066cc' }};
    --site-secondary: {{ colors.secondary or colors.primary or '#004499' }};
    --site-accent: {{ colors.accent or '#00ccff' }};
    --site-text: {{ colors.text or '#1a1a2e' }};
  }
  /* Apply site primary color to editor accents */
  .btn-primary {
    background: linear-gradient(135deg, {{ colors.primary or '#0066cc' }} 0%, {{ colors.get('primary-hover') or colors.primary or '#0052a3' }} 100%) !important;
    border: none !important;
  }
  .btn-primary:hover {
    background: linear-gradient(135deg, {{ colors.get('primary-hover') or colors.primary or '#0052a3' }} 0%, {{ colors.accent or colors.primary or '#0066cc' }} 100%) !important;
  }
  .text-primary, .bi.text-primary {
    color: {{ colors.primary or '#0066cc' }} !important;
  }
  .card-header {
    background: linear-gradient(135deg, {{ colors.primary or '#0066cc' }} 0%, {{ colors.get('primary-hover') or colors.secondary or '#004499' }} 100%) !important;
  }
  .navbar {
    background: linear-gradient(135deg, {{ colors.text or '#1a1a2e' }} 0%, {{ colors.primary or '#0066cc' }} 150%) !important;
    border-bottom-color: {{ colors.accent or colors.primary or '#00ccff' }} !important;
  }
  .component-item:hover {
    border-color: {{ colors.primary or '#0066cc' }} !important;
    background: {{ colors.background or '#f8fafc' }} !important;
  }
  .btn-outline-primary {
    color: {{ colors.primary or '#0066cc' }} !important;
    border-color: {{ colors.primary or '#0066cc' }} !important;
  }
  .btn-outline-primary:hover {
    background: {{ colors.primary or '#0066cc' }} !important;
    color: white !important;
  }
  .form-control:focus, .form-select:focus {
    border-color: {{ colors.accent or colors.primary or '#0066cc' }} !important;
    box-shadow: 0 0 0 0.2rem {{ colors.primary or '#0066cc' }}40 !important;
  }
  .form-check-input:checked {
    background-color: {{ colors.primary or '#0066cc' }} !important;
    border-color: {{ colors.primary or '#0066cc' }} !important;
  }
  a:not(.btn):not(.nav-link) {
    color: {{ colors.primary or '#0066cc' }};
  }
  a:not(.btn):not(.nav-link):hover {
    color: {{ colors.get('primary-hover') or colors.primary or '#0052a3' }};
  }
  .badge.bg-primary {
    background: {{ colors.primary or '#0066cc' }} !important;
  }
</style>
{% endif %}
<div class="row">
  <!-- Component Panel -->
  <div class="col-md-3">
    <div class="card mb-4">
      <div class="card-header">
        <i class="bi bi-arrow-left"></i>
        <a href="{{ url_for('builder_dashboard') }}" class="text-decoration-none">Back to Dashboard</a>
      </div>
    </div>

    <!-- Page Settings -->
    <div class="card mb-4">
      <div class="card-header">
        <i class="bi bi-file-earmark-text"></i> Page Settings
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label small">Page Title</label>
          <input type="text" class="form-control form-control-sm" id="pageTitle" value="{{ page.title }}">
        </div>
        <div class="mb-3">
          <label class="form-label small">Meta Description</label>
          <textarea class="form-control form-control-sm" id="metaDescription" rows="2">{{ page.meta_description or '' }}</textarea>
        </div>
        {% if page.id != 'index' %}
        <hr>
        <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="showDeletePageModal()">
          <i class="bi bi-trash"></i> Delete This Page
        </button>
        {% endif %}
      </div>
    </div>

    <!-- Add Components -->
    <div class="card mb-4" id="addComponentCard">
      <div class="card-header">
        <i class="bi bi-plus-square"></i> Add Component
      </div>
      <div class="card-body p-2">
        <p class="small text-muted mb-2">Click to add (hover to preview):</p>
        <div class="component-list">
          {% for component in components %}
          {% if component.category not in ['navigation', 'footer', 'sidebar'] %}
          <div class="component-item p-2 mb-2 border rounded"
               data-component-id="{{ component.id }}"
               onclick="addComponent('{{ component.id }}')"
               onmouseenter="showComponentPreview('{{ component.id }}')"
               onmouseleave="hideComponentPreview()">
            <div class="d-flex align-items-center">
              <i class="bi bi-{{ component.thumbnail }} me-2 text-primary"></i>
              <div class="flex-grow-1">
                <div class="small fw-bold">{{ component.name }}</div>
                <div class="text-muted" style="font-size: 0.75rem;">{{ component.description[:40] }}...</div>
              </div>
              <i class="bi bi-plus-circle text-success"></i>
            </div>
          </div>
          {% endif %}
          {% endfor %}
        </div>
        <!-- Component Preview Popup -->
        <div id="componentPreviewPopup" class="component-preview-popup" style="display: none;">
          <div class="preview-header">
            <span id="previewComponentName">Component Preview</span>
          </div>
          <div class="preview-content">
            <iframe id="componentPreviewFrame" style="width: 100%; height: 200px; border: none; pointer-events: none;"></iframe>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Editor Area -->
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-layers"></i> Page Content</span>
        <div>
          <button class="btn btn-sm btn-outline-secondary" onclick="refreshPreview()">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
          <button class="btn btn-sm btn-primary" onclick="savePage()">
            <i class="bi bi-check"></i> Save
          </button>
        </div>
      </div>
      <div class="card-body p-2">
        <div class="slot-content" id="slot-main">
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Panel -->
  <div class="col-md-3">
    <div class="card" style="position: sticky; top: 1rem;">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-eye"></i> Preview</span>
        <button class="btn btn-sm btn-outline-secondary" onclick="openFullPreview()" title="Open full preview">
          <i class="bi bi-box-arrow-up-right"></i>
        </button>
      </div>
      <div class="card-body p-0">
        <iframe id="previewFrame" src="{{ url_for('builder_preview', page_id=page.id) }}"
                style="width: 100%; height: 500px; border: none; transform-origin: top left; transform: scale(0.5); width: 200%; height: 1000px;">
        </iframe>
      </div>
    </div>
  </div>
</div>

<!-- Edit Component Modal -->
<div class="modal fade" id="editComponentModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Component</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="editComponentBody">
        <!-- Dynamic form fields -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger me-auto" onclick="deleteCurrentComponent()">
          <i class="bi bi-trash"></i> Delete
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveComponentEdits()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Page Confirmation Modal -->
<div class="modal fade" id="deletePageModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Delete Page</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the page "<strong>{{ page.title }}</strong>"?</p>
        <p class="text-danger mb-0"><i class="bi bi-exclamation-circle"></i> This action is permanent and cannot be undone. The page and all its content will be permanently deleted.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="deletePage()">
          <i class="bi bi-trash"></i> Delete Permanently
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Image Browser Modal -->
<div class="modal fade" id="imageBrowserModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-images"></i> Select Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Upload Section -->
        <div class="mb-4">
          <div class="upload-dropzone p-4 border rounded text-center" id="imageDropzone">
            <i class="bi bi-cloud-upload fs-1 text-muted"></i>
            <p class="mb-2">Drag & drop an image here, or click to browse</p>
            <input type="file" id="imageUploadInput" accept="image/*" style="display: none;">
            <button class="btn btn-primary" onclick="document.getElementById('imageUploadInput').click()">
              <i class="bi bi-upload"></i> Upload Image
            </button>
          </div>
          <div id="uploadProgress" class="mt-2" style="display: none;">
            <div class="progress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
            </div>
            <small class="text-muted">Uploading...</small>
          </div>
        </div>

        <!-- Existing Images Grid -->
        <h6 class="mb-3">Existing Images</h6>
        <div id="imageGrid" class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-2">
          <div class="col text-center text-muted py-4">
            <i class="bi bi-hourglass-split"></i> Loading...
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <span id="imageListModeHint" class="text-muted small me-auto" style="display: none;">
          <i class="bi bi-info-circle"></i> Click images to select them for gallery
        </span>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="imageBrowserCancelBtn">
          <span id="imageBrowserCancelText">Cancel</span>
        </button>
        <button type="button" class="btn btn-primary" onclick="submitImageSelections()" id="imageBrowserDoneBtn" style="display: none;">
          <i class="bi bi-check"></i> <span id="imageBrowserDoneText">Done</span>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .component-item {
    cursor: pointer;
    transition: all 0.2s;
    border-color: #dee2e6 !important;
  }
  .component-item:hover {
    background-color: #e7f1ff;
    border-color: #0d6efd !important;
    transform: translateX(4px);
  }
  .component-item:hover .bi-plus-circle {
    transform: scale(1.2);
  }
  .component-item .bi-plus-circle {
    transition: transform 0.2s;
  }

  /* Component Preview Popup */
  .component-preview-popup {
    position: absolute;
    left: 105%;
    top: 0;
    width: 350px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    overflow: hidden;
  }
  .component-preview-popup .preview-header {
    background: #f8f9fa;
    padding: 8px 12px;
    border-bottom: 1px solid #dee2e6;
    font-weight: 500;
    font-size: 0.875rem;
  }
  .component-preview-popup .preview-content {
    background: #f0f0f0;
    padding: 8px;
  }
  .component-preview-popup .preview-content iframe {
    background: white;
    border-radius: 4px;
  }

  /* Position the component list container as relative for popup positioning */
  .component-list {
    position: relative;
  }

  .slot-content {
    min-height: 60px;
    background: #fafafa;
  }

  .slot-content:empty::after {
    content: 'Drop components here';
    display: block;
    padding: 1rem;
    text-align: center;
    color: #aaa;
    font-style: italic;
  }

  .page-component {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    cursor: move;
    transition: all 0.2s;
  }

  .page-component:hover {
    border-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .page-component.dragging {
    opacity: 0.5;
  }

  .page-component .component-actions {
    opacity: 0;
    transition: opacity 0.2s;
  }

  .page-component:hover .component-actions {
    opacity: 1;
  }

  .drag-over {
    border: 2px dashed #0d6efd;
    background: #e7f1ff;
  }

  /* Image Browser Styles */
  .upload-dropzone {
    border: 2px dashed #dee2e6;
    background: #f8f9fa;
    transition: all 0.2s;
  }
  .upload-dropzone:hover, .upload-dropzone.drag-over {
    border-color: #0d6efd;
    background: #e7f1ff;
  }
  .image-thumb {
    cursor: pointer;
    border: 2px solid transparent;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.2s;
    aspect-ratio: 1;
  }
  .image-thumb:hover {
    border-color: #0d6efd;
    transform: scale(1.05);
  }
  .image-thumb.selected {
    border-color: #198754 !important;
    box-shadow: 0 0 0 3px rgba(25, 135, 84, 0.3);
  }
  .selection-badge {
    position: absolute;
    top: 4px;
    left: 4px;
    background: #198754;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
    z-index: 10;
  }
  .image-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .image-thumb .image-name {
    font-size: 0.7rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding: 4px;
    background: rgba(0,0,0,0.7);
    color: white;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
  }
  .image-preview-container {
    position: relative;
    width: 60px;
    height: 60px;
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid #dee2e6;
  }
  .image-preview-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Custom Tooltip */
  .tooltip-trigger {
    cursor: help;
    position: relative;
  }
  .custom-tooltip {
    position: fixed;
    background: #1a3a2f;
    color: white;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 0.85rem;
    max-width: 300px;
    z-index: 9999;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    pointer-events: none;
    line-height: 1.4;
  }
  .custom-tooltip::before {
    content: '';
    position: absolute;
    top: -6px;
    left: 20px;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 6px solid #1a3a2f;
  }

  /* Image List Styles (for gallery component) */
  .imagelist-container .row {
    min-height: 80px;
  }
  .imagelist-container .image-thumb {
    width: 100%;
    height: 80px;
    background: #f8f9fa;
  }
  .imagelist-container .image-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .imagelist-container .row:empty::after {
    content: 'No images yet. Click "Add Images" to add some.';
    display: block;
    padding: 1rem;
    text-align: center;
    color: #aaa;
    font-style: italic;
    width: 100%;
  }

  /* Nested Component Slot Styles */
  .componentslot-container {
    background: #f8f9fa;
  }
  .nested-component-item {
    transition: all 0.2s;
  }
  .nested-component-item:hover {
    background: #e9ecef !important;
    border-color: #0d6efd !important;
  }
  .slot-component-list:empty::after {
    content: 'No components in this slot';
    display: block;
    padding: 0.5rem;
    text-align: center;
    color: #aaa;
    font-style: italic;
  }

  /* Ensure image browser modal appears above nested edit modals */
  #imageBrowserModal {
    z-index: 1070 !important;
  }
  #imageBrowserModal + .modal-backdrop {
    z-index: 1065 !important;
  }
  #nestedEditModal {
    z-index: 1060 !important;
  }
  #nestedEditModal + .modal-backdrop {
    z-index: 1055 !important;
  }

  /* Rich Text Editor Styles */
  .richtext-editor-container {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    overflow: visible;
  }
  .richtext-toolbar {
    border-bottom: 1px solid #dee2e6;
    border-radius: 0.375rem 0.375rem 0 0 !important;
    flex-wrap: wrap;
    position: relative;
    z-index: 10;
  }
  .richtext-toolbar .btn {
    padding: 0.25rem 0.5rem;
  }
  .richtext-toolbar .dropdown-menu {
    z-index: 1060;
    position: absolute;
  }
  .richtext-toolbar .font-dropdown,
  .richtext-toolbar .size-dropdown {
    max-height: 300px;
    overflow-y: auto;
  }
  /* Ensure modal body allows dropdowns to overflow */
  #editComponentModal .modal-body,
  #nestedEditModal .modal-body {
    overflow: visible;
  }
  #editComponentModal .modal-content,
  #nestedEditModal .modal-content {
    overflow: visible;
  }
  .richtext-editor {
    border: none !important;
    border-radius: 0 0 0.375rem 0.375rem !important;
    background: white;
  }
  .richtext-editor:focus {
    box-shadow: none;
    outline: none;
  }
  .richtext-editor p {
    margin-bottom: 0.5rem;
  }
  .richtext-editor a {
    color: var(--bs-primary);
    text-decoration: underline;
  }
  .emoji-popup {
    display: flex;
    flex-wrap: wrap;
    max-width: 250px;
  }

  /* Component Section Styles */
  .component-section {
    overflow: visible;
  }
  .component-section .section-header {
    border-bottom: 1px solid #dee2e6;
    user-select: none;
  }
  .component-section .section-header:hover {
    background-color: #e9ecef !important;
  }
  .component-section .section-content {
    background: #fafafa;
  }
  .component-section .section-content .mb-3:last-child {
    margin-bottom: 0 !important;
  }
</style>

<script>
  console.log('Page editor script starting...');
  const pageId = '{{ page.id }}';
  let pageData = {{ page | tojson | safe }};
  console.log('pageData:', pageData);
  let componentsLib = {{ components | tojson | safe }};
  console.log('componentsLib:', componentsLib);
  let editModal;
  let deletePageModal;
  let currentEditingComponent = null;
  let currentEditingSlot = null;
  let currentEditingIndex = null;

  // Track unsaved changes
  let hasUnsavedChanges = false;
  let savedPageDataJSON = null;

  document.addEventListener('DOMContentLoaded', function() {
    editModal = new bootstrap.Modal(document.getElementById('editComponentModal'));
    deletePageModal = new bootstrap.Modal(document.getElementById('deletePageModal'));
    renderAllSlots();
    initDragAndDrop();
    initImageBrowser();
    initTooltips();
    // Store initial state to detect changes
    savedPageDataJSON = JSON.stringify(pageData);
    // Note: Don't call refreshPreview() here - the iframe loads via its src attribute initially
    // refreshPreview() is called when user makes changes to trigger live preview updates

    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', function(e) {
      if (hasUnsavedChanges || JSON.stringify(pageData) !== savedPageDataJSON) {
        e.preventDefault();
        e.returnValue = '';
        return '';
      }
    });
  });

  function showDeletePageModal() {
    deletePageModal.show();
  }

  async function deletePage() {
    try {
      const response = await fetch(`/builder/pages/${pageId}/delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const data = await response.json();

      if (data.success) {
        window.location.href = '/builder';
      } else {
        alert('Error deleting page: ' + data.error);
        deletePageModal.hide();
      }
    } catch (error) {
      alert('Error deleting page: ' + error.message);
      deletePageModal.hide();
    }
  }

  function renderAllSlots() {
    renderSlot('main');
  }

  function renderSlot(slotName) {
    console.log('renderSlot called for:', slotName);
    const container = document.getElementById('slot-' + slotName);
    console.log('container:', container);
    const components = pageData.slots[slotName] || [];
    console.log('components to render:', components);

    container.innerHTML = '';

    components.forEach((comp, index) => {
      const compDef = componentsLib.find(c => c.id === comp.type);
      const compName = compDef ? compDef.name : comp.type;

      const div = document.createElement('div');
      div.className = 'page-component';
      div.draggable = true;
      div.dataset.slot = slotName;
      div.dataset.index = index;

      div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <i class="bi bi-grip-vertical text-muted me-2"></i>
            <strong>${compName}</strong>
            <span class="text-muted small ms-2">${getComponentPreview(comp)}</span>
          </div>
          <div class="component-actions">
            <button class="btn btn-sm btn-outline-secondary" onclick="duplicateComponent('${slotName}', ${index})" title="Duplicate">
              <i class="bi bi-copy"></i>
            </button>
            <button class="btn btn-sm btn-outline-primary" onclick="editComponent('${slotName}', ${index})" title="Edit">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="removeComponent('${slotName}', ${index})" title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      `;

      container.appendChild(div);
    });
  }

  function getComponentPreview(comp) {
    if (!comp || !comp.data) return '';

    let preview = '';
    if (comp.data.title) preview = comp.data.title.substring(0, 30) + (comp.data.title.length > 30 ? '...' : '');
    else if (comp.data.heading) preview = comp.data.heading.substring(0, 30) + (comp.data.heading.length > 30 ? '...' : '');
    else if (comp.data.site_name) preview = comp.data.site_name;

    // Show anchor_id if present
    if (comp.data.anchor_id) {
      const idDisplay = `<span class="text-primary opacity-75">#${comp.data.anchor_id}</span>`;
      return preview ? `${preview} ${idDisplay}` : idDisplay;
    }
    return preview;
  }

  // Full preview opens in new tab
  function openFullPreview() {
    // Create a form to POST the current page data to preview
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/builder/preview/{{ page.id }}';
    form.target = '_blank';

    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'page_data';
    input.value = JSON.stringify(pageData);
    form.appendChild(input);

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
  }

  function showToast(message, type = 'success') {
    // Create toast container if it doesn't exist
    let container = document.getElementById('toastContainer');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toastContainer';
      container.className = 'position-fixed bottom-0 end-0 p-3';
      container.style.zIndex = '1100';
      document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0 show`;
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
      </div>
    `;
    container.appendChild(toast);

    setTimeout(() => toast.remove(), 3000);
  }

  // Component preview on hover
  let previewTimeout = null;

  function showComponentPreview(componentId) {
    // Small delay to avoid flickering
    previewTimeout = setTimeout(async () => {
      const compDef = componentsLib.find(c => c.id === componentId);
      if (!compDef) return;

      const popup = document.getElementById('componentPreviewPopup');
      const nameEl = document.getElementById('previewComponentName');
      const iframe = document.getElementById('componentPreviewFrame');

      nameEl.textContent = compDef.name;

      // Special animated preview for General component
      if (componentId === 'content-block') {
        iframe.srcdoc = getGeneralComponentPreview();
        popup.style.display = 'block';
        return;
      }

      // Fetch component preview
      try {
        const response = await fetch('/builder/component/preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            component_type: componentId,
            component_data: compDef.default_data
          })
        });

        const data = await response.json();
        if (data.success) {
          iframe.srcdoc = data.html;
        }
      } catch (error) {
        console.error('Preview error:', error);
      }

      popup.style.display = 'block';
    }, 200);
  }

  function getGeneralComponentPreview() {
    return `<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(180deg, #f2f7f2 0%, #e8f0e8 100%);
      font-family: system-ui, -apple-system, sans-serif;
      overflow: hidden;
    }
    .preview-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(26, 58, 47, 0.1);
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .preview-image {
      width: 120px;
      height: 90px;
      border-radius: 8px;
      background: linear-gradient(135deg, #3d7a5f 0%, #4a9970 100%);
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }
    .tree {
      position: absolute;
      bottom: 0;
      transform-origin: bottom center;
    }
    .tree1 { left: 15%; animation: sway 3s ease-in-out infinite; }
    .tree2 { left: 40%; animation: sway 3.5s ease-in-out infinite 0.5s; }
    .tree3 { left: 65%; animation: sway 2.8s ease-in-out infinite 0.2s; }
    @keyframes sway {
      0%, 100% { transform: rotate(-3deg); }
      50% { transform: rotate(3deg); }
    }
    .sun {
      position: absolute;
      top: 10px;
      right: 15px;
      width: 20px;
      height: 20px;
      background: #ffd93d;
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    .preview-text {
      flex: 1;
    }
    .preview-title {
      color: #1a3a2f;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .preview-line {
      height: 8px;
      background: #e8f0e8;
      border-radius: 4px;
      margin-bottom: 6px;
    }
    .preview-line.short { width: 70%; }
    .preview-line.medium { width: 90%; }
    .preview-badge {
      display: inline-block;
      background: linear-gradient(135deg, #2d5a47 0%, #3d7a5f 100%);
      color: white;
      font-size: 9px;
      padding: 3px 8px;
      border-radius: 10px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="preview-container">
    <div class="preview-image">
      <div class="sun"></div>
      <svg class="tree tree1" width="25" height="50" viewBox="0 0 25 50">
        <polygon points="12.5,5 22,35 3,35" fill="#1a3a2f"/>
        <rect x="10" y="35" width="5" height="15" fill="#4a3525"/>
      </svg>
      <svg class="tree tree2" width="30" height="60" viewBox="0 0 30 60">
        <polygon points="15,0 28,42 2,42" fill="#2d5a47"/>
        <rect x="12" y="42" width="6" height="18" fill="#4a3525"/>
      </svg>
      <svg class="tree tree3" width="22" height="45" viewBox="0 0 22 45">
        <polygon points="11,5 20,32 2,32" fill="#3d7a5f"/>
        <rect x="9" y="32" width="4" height="13" fill="#6b5240"/>
      </svg>
    </div>
    <div class="preview-text">
      <div class="preview-title">Your Content Here</div>
      <div class="preview-line medium"></div>
      <div class="preview-line"></div>
      <div class="preview-line short"></div>
      <span class="preview-badge">Text + Images + More</span>
    </div>
  </div>
</body>
</html>`;
  }

  function hideComponentPreview() {
    if (previewTimeout) {
      clearTimeout(previewTimeout);
      previewTimeout = null;
    }
    document.getElementById('componentPreviewPopup').style.display = 'none';
  }

  function generateComponentAnchorId(componentType) {
    // Generate timestamp-based ID: component-type-YYYYMMDD-HHMMSS
    const now = new Date();
    const timestamp = now.getFullYear().toString() +
      (now.getMonth() + 1).toString().padStart(2, '0') +
      now.getDate().toString().padStart(2, '0') + '-' +
      now.getHours().toString().padStart(2, '0') +
      now.getMinutes().toString().padStart(2, '0') +
      now.getSeconds().toString().padStart(2, '0');
    return `${componentType}-${timestamp}`;
  }

  function addComponent(componentId) {
    hideComponentPreview(); // Hide preview when adding
    const compDef = componentsLib.find(c => c.id === componentId);

    if (!compDef) {
      showToast('Component not found', 'danger');
      return;
    }

    // Generate unique id for the component
    const compId = 'comp-' + Date.now();

    const newComponent = {
      id: compId,
      type: componentId,
      data: JSON.parse(JSON.stringify(compDef.default_data))
    };

    // Auto-generate anchor_id if the component has that field
    if (compDef.editable_fields.some(f => f.name === 'anchor_id')) {
      newComponent.data.anchor_id = generateComponentAnchorId(componentId);
    }

    if (!pageData.slots.main) {
      pageData.slots.main = [];
    }

    pageData.slots.main.push(newComponent);
    renderSlot('main');
    refreshPreview();

    // Show success feedback
    showToast(`Added "${compDef.name}"`);

    // Highlight the slot where component was added
    const slotEl = document.getElementById('slot-main');
    slotEl.classList.add('bg-success-subtle');
    setTimeout(() => slotEl.classList.remove('bg-success-subtle'), 1000);
  }

  function editComponent(slotName, index) {
    currentEditingSlot = slotName;
    currentEditingIndex = index;
    currentEditingComponent = pageData.slots[slotName][index];

    console.log('=== Editing component ===');
    console.log('Component data:', JSON.stringify(currentEditingComponent.data, null, 2));

    const compDef = componentsLib.find(c => c.id === currentEditingComponent.type);
    if (!compDef) {
      alert('Component definition not found');
      return;
    }

    document.querySelector('#editComponentModal .modal-title').textContent = 'Edit ' + compDef.name;

    const body = document.getElementById('editComponentBody');
    body.innerHTML = '';

    if (compDef.has_sections) {
      // Group fields by section, preserving order
      const sections = {};
      const sectionOrder = [];
      const noSection = [];

      compDef.editable_fields.forEach(field => {
        if (field.section) {
          if (!sections[field.section]) {
            sections[field.section] = [];
            sectionOrder.push(field.section);
          }
          sections[field.section].push(field);
        } else {
          noSection.push(field);
        }
      });

      // Render each section in order
      sectionOrder.forEach(sectionName => {
        const sectionFields = sections[sectionName];
        const toggleField = sectionFields.find(f => f.type === 'section_toggle');
        const otherFields = sectionFields.filter(f => f.type !== 'section_toggle');

        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'component-section mb-3 border rounded';

        // Section header with separate collapse and enable controls
        const header = document.createElement('div');
        header.className = 'section-header d-flex align-items-center p-2 bg-light rounded-top';

        // Collapse/expand icon (left side) - starts collapsed
        const collapseBtn = document.createElement('button');
        collapseBtn.type = 'button';
        collapseBtn.className = 'btn btn-sm btn-link p-0 me-2 text-muted';
        collapseBtn.innerHTML = '<i class="bi bi-chevron-right"></i>';
        collapseBtn.title = 'Collapse/Expand';

        // Enable checkbox (separate from collapse)
        const toggleValue = toggleField ? (currentEditingComponent.data[toggleField.name] !== undefined ? currentEditingComponent.data[toggleField.name] : toggleField.default) : true;
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input me-2';
        checkbox.checked = toggleValue === true || toggleValue === 'true';
        checkbox.dataset.fieldKey = toggleField ? toggleField.name : '';
        checkbox.id = 'section_enable_' + sectionName;
        checkbox.title = 'Enable/Disable this section';

        const headerLabel = document.createElement('label');
        headerLabel.className = 'form-check-label fw-medium flex-grow-1 mb-0';
        headerLabel.htmlFor = checkbox.id;
        headerLabel.textContent = toggleField ? toggleField.label : sectionName;
        headerLabel.style.cursor = 'pointer';

        header.appendChild(collapseBtn);
        header.appendChild(checkbox);
        header.appendChild(headerLabel);
        sectionDiv.appendChild(header);

        // Section content (collapsible) - starts collapsed
        const content = document.createElement('div');
        content.className = 'section-content p-2';
        content.style.display = 'none'; // Start collapsed

        otherFields.forEach(field => {
          const value = currentEditingComponent.data[field.name] !== undefined ? currentEditingComponent.data[field.name] : (field.default !== undefined ? field.default : '');
          content.appendChild(createFieldEditor(field, value));
        });

        sectionDiv.appendChild(content);

        // Collapse button only controls visibility (not enable/disable)
        const toggleCollapse = () => {
          const isCollapsed = content.style.display === 'none';
          content.style.display = isCollapsed ? 'block' : 'none';
          collapseBtn.innerHTML = isCollapsed ? '<i class="bi bi-chevron-down"></i>' : '<i class="bi bi-chevron-right"></i>';
        };

        collapseBtn.onclick = (e) => {
          e.stopPropagation();
          toggleCollapse();
        };

        // Clicking the label also toggles collapse
        headerLabel.onclick = (e) => {
          if (e.target === checkbox) return;
          toggleCollapse();
        };

        // Visual feedback when section is disabled
        const updateDisabledState = () => {
          content.style.opacity = checkbox.checked ? '1' : '0.5';
          headerLabel.style.textDecoration = checkbox.checked ? 'none' : 'line-through';
        };
        checkbox.onchange = () => {
          updateDisabledState();
          // Auto-initialize timestamp field when timestamp section is enabled
          if (checkbox.checked && sectionName === 'timestamp') {
            const datetimeInput = content.querySelector('input[type="datetime-local"]');
            if (datetimeInput && !datetimeInput.value) {
              // Set to current date/time
              const now = new Date();
              datetimeInput.value = now.toISOString().substring(0, 16);
            }
          }
        };
        updateDisabledState();

        body.appendChild(sectionDiv);
      });

      // Render fields without section
      noSection.forEach(field => {
        const value = currentEditingComponent.data[field.name] !== undefined ? currentEditingComponent.data[field.name] : (field.default !== undefined ? field.default : '');
        body.appendChild(createFieldEditor(field, value));
      });
    } else {
      // No sections - render fields normally
      compDef.editable_fields.forEach(field => {
        const value = currentEditingComponent.data[field.name] !== undefined ? currentEditingComponent.data[field.name] : (field.default !== undefined ? field.default : '');
        body.appendChild(createFieldEditor(field, value));
      });
    }

    editModal.show();
  }

  function createFieldEditor(field, value) {
    const div = document.createElement('div');
    div.className = 'mb-3';

    const label = document.createElement('label');
    label.className = 'form-label';
    label.textContent = field.label;
    div.appendChild(label);

    let input;

    switch (field.type) {
      case 'section_toggle':
        // Section toggles are handled by editComponent's section grouping
        // Return an empty div if somehow rendered directly
        return div;

      case 'textarea': {
        input = document.createElement('textarea');
        input.className = 'form-control';
        input.rows = 4;
        input.value = value;
        input.dataset.fieldKey = field.name;
        div.appendChild(input);
        return div;
      }

      case 'richtext': {
        // Rich text editor with formatting toolbar
        const rtContainer = document.createElement('div');
        rtContainer.className = 'richtext-editor-container';
        rtContainer.dataset.fieldKey = field.name;

        // Toolbar
        const toolbar = document.createElement('div');
        toolbar.className = 'richtext-toolbar btn-toolbar mb-1 p-1 border rounded-top bg-light';
        toolbar.innerHTML = `
          <div class="btn-group btn-group-sm me-1">
            <button type="button" class="btn btn-outline-secondary" onclick="rtExec('bold')" title="Bold"><i class="bi bi-type-bold"></i></button>
            <button type="button" class="btn btn-outline-secondary" onclick="rtExec('italic')" title="Italic"><i class="bi bi-type-italic"></i></button>
            <button type="button" class="btn btn-outline-secondary" onclick="rtExec('underline')" title="Underline"><i class="bi bi-type-underline"></i></button>
            <button type="button" class="btn btn-outline-secondary" onclick="rtExec('strikeThrough')" title="Strikethrough"><i class="bi bi-type-strikethrough"></i></button>
          </div>
          <div class="btn-group btn-group-sm me-1">
            <button type="button" class="btn btn-outline-secondary" onclick="rtExec('hiliteColor', 'yellow')" title="Highlight"><i class="bi bi-highlighter"></i></button>
            <button type="button" class="btn btn-outline-secondary" onclick="rtPromptColor()" title="Text Color"><i class="bi bi-palette"></i></button>
          </div>
          <div class="btn-group btn-group-sm me-1">
            <button type="button" class="btn btn-outline-secondary" onclick="rtPromptLink()" title="Insert Link"><i class="bi bi-link-45deg"></i></button>
            <button type="button" class="btn btn-outline-secondary" onclick="rtExec('unlink')" title="Remove Link"><i class="bi bi-link"></i></button>
          </div>
          <div class="btn-group btn-group-sm me-1">
            <button type="button" class="btn btn-outline-secondary" onclick="rtExec('insertUnorderedList')" title="Bullet List"><i class="bi bi-list-ul"></i></button>
            <button type="button" class="btn btn-outline-secondary" onclick="rtExec('insertOrderedList')" title="Numbered List"><i class="bi bi-list-ol"></i></button>
          </div>
          <div class="btn-group btn-group-sm me-1">
            <div class="dropdown">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Font">
                <i class="bi bi-fonts"></i>
              </button>
              <ul class="dropdown-menu font-dropdown">
                <li><a class="dropdown-item" href="#" onclick="rtApplyFont('inherit'); return false;" style="font-family: inherit;">Default</a></li>
                <li><a class="dropdown-item" href="#" onclick="rtApplyFont('Arial'); return false;" style="font-family: Arial;">Arial</a></li>
                <li><a class="dropdown-item" href="#" onclick="rtApplyFont('Georgia'); return false;" style="font-family: Georgia;">Georgia</a></li>
                <li><a class="dropdown-item" href="#" onclick="rtApplyFont('Times New Roman'); return false;" style="font-family: 'Times New Roman';">Times New Roman</a></li>
                <li><a class="dropdown-item" href="#" onclick="rtApplyFont('Verdana'); return false;" style="font-family: Verdana;">Verdana</a></li>
                <li><a class="dropdown-item" href="#" onclick="rtApplyFont('monospace'); return false;" style="font-family: monospace;">Monospace</a></li>
              </ul>
            </div>
            <div class="dropdown">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Size">
                <i class="bi bi-type"></i>
              </button>
              <ul class="dropdown-menu size-dropdown">
                <li><a class="dropdown-item" href="#" onclick="rtApplySize('0.875rem'); return false;" style="font-size: 0.875rem;">Small</a></li>
                <li><a class="dropdown-item" href="#" onclick="rtApplySize('1rem'); return false;" style="font-size: 1rem;">Normal</a></li>
                <li><a class="dropdown-item" href="#" onclick="rtApplySize('1.25rem'); return false;" style="font-size: 1.125rem;">Large</a></li>
                <li><a class="dropdown-item" href="#" onclick="rtApplySize('1.5rem'); return false;" style="font-size: 1.25rem;">X-Large</a></li>
                <li><a class="dropdown-item" href="#" onclick="rtApplySize('2rem'); return false;" style="font-size: 1.5rem;">2X-Large</a></li>
                <li><a class="dropdown-item" href="#" onclick="rtApplySize('2.5rem'); return false;" style="font-size: 1.75rem;">3X-Large</a></li>
                <li><a class="dropdown-item" href="#" onclick="rtApplySize('3.5rem'); return false;" style="font-size: 2rem;">Hero</a></li>
              </ul>
            </div>
          </div>
          <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-secondary" onclick="rtInsertEmoji(this)" title="Emoji"><i class="bi bi-emoji-smile"></i></button>
          </div>
        `;
        rtContainer.appendChild(toolbar);

        // Editable area
        const editor = document.createElement('div');
        editor.className = 'richtext-editor form-control';
        editor.contentEditable = 'true';
        editor.style.minHeight = '150px';
        editor.style.maxHeight = '400px';
        editor.style.overflow = 'auto';
        editor.innerHTML = value || '<p></p>';
        rtContainer.appendChild(editor);

        // Hidden input to store value
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.dataset.fieldKey = field.name;
        hiddenInput.value = value || '';
        rtContainer.appendChild(hiddenInput);

        // Sync editor content to hidden input on changes
        editor.addEventListener('input', () => {
          hiddenInput.value = editor.innerHTML;
        });
        editor.addEventListener('blur', () => {
          hiddenInput.value = editor.innerHTML;
        });

        div.appendChild(rtContainer);
        return div;
      }

      case 'range': {
        // Range slider with value display
        const rangeContainer = document.createElement('div');
        rangeContainer.className = 'd-flex align-items-center gap-2';

        input = document.createElement('input');
        input.type = 'range';
        input.className = 'form-range flex-grow-1';
        input.min = field.min || 0;
        input.max = field.max || 100;
        input.value = value !== undefined && value !== '' ? value : (field.default || 50);

        const rangeValue = document.createElement('span');
        rangeValue.className = 'badge bg-secondary';
        rangeValue.style.minWidth = '40px';
        rangeValue.textContent = input.value + '%';

        input.addEventListener('input', () => {
          rangeValue.textContent = input.value + '%';
        });

        rangeContainer.appendChild(input);
        rangeContainer.appendChild(rangeValue);
        input.dataset.fieldKey = field.name;
        div.appendChild(rangeContainer);
        return div;
      }

      case 'datetime': {
        input = document.createElement('input');
        input.type = 'datetime-local';
        input.className = 'form-control';
        // Convert ISO string to datetime-local format if needed
        if (value) {
          input.value = value.substring(0, 16);
        }
        input.dataset.fieldKey = field.name;
        div.appendChild(input);
        return div;
      }

      case 'select': {
        input = document.createElement('select');
        input.className = 'form-select';
        (field.options || []).forEach(opt => {
          const option = document.createElement('option');
          // Handle both string options and {value, label} objects
          const optValue = typeof opt === 'string' ? opt : opt.value;
          const optLabel = typeof opt === 'string' ? opt : opt.label;
          option.value = optValue;
          option.textContent = optLabel;
          option.selected = optValue === value;
          input.appendChild(option);
        });
        input.dataset.fieldKey = field.name;
        div.appendChild(input);
        return div;
      }

      case 'image': {
        // Container for preview + input
        const imageContainer = document.createElement('div');
        imageContainer.className = 'd-flex gap-3 align-items-start';

        // Preview thumbnail
        const previewContainer = document.createElement('div');
        previewContainer.className = 'image-preview-container';
        const previewImg = document.createElement('img');
        previewImg.src = value || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60"><rect fill="%23f0f0f0" width="60" height="60"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23999" font-size="10">No image</text></svg>';
        previewImg.alt = 'Preview';
        previewImg.onerror = () => {
          previewImg.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60"><rect fill="%23f0f0f0" width="60" height="60"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23999" font-size="10">No image</text></svg>';
        };
        previewContainer.appendChild(previewImg);
        imageContainer.appendChild(previewContainer);

        // Input and buttons wrapper
        const inputWrapper = document.createElement('div');
        inputWrapper.className = 'flex-grow-1';

        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';

        input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control';
        input.value = value;
        input.placeholder = 'Image URL or click Browse';
        input.onchange = () => {
          previewImg.src = input.value || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60"><rect fill="%23f0f0f0" width="60" height="60"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23999" font-size="10">No image</text></svg>';
        };

        // Browse button - opens image browser modal
        const browseBtn = document.createElement('button');
        browseBtn.type = 'button';
        browseBtn.className = 'btn btn-outline-primary';
        browseBtn.innerHTML = '<i class="bi bi-images"></i> Browse';
        browseBtn.title = 'Browse existing images';
        browseBtn.onclick = () => openImageBrowser(input, previewImg);

        // Upload button - quick upload
        const uploadBtn = document.createElement('button');
        uploadBtn.type = 'button';
        uploadBtn.className = 'btn btn-outline-secondary';
        uploadBtn.innerHTML = '<i class="bi bi-upload"></i>';
        uploadBtn.title = 'Upload new image';
        uploadBtn.onclick = () => {
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = 'image/*';
          fileInput.onchange = async (e) => {
            if (e.target.files[0]) {
              await uploadImageFile(e.target.files[0], input, previewImg);
            }
          };
          fileInput.click();
        };

        inputGroup.appendChild(input);
        inputGroup.appendChild(browseBtn);
        inputGroup.appendChild(uploadBtn);
        inputWrapper.appendChild(inputGroup);

        // Help text
        const helpText = document.createElement('small');
        helpText.className = 'text-muted';
        helpText.textContent = 'Browse existing images or upload a new one';
        inputWrapper.appendChild(helpText);

        imageContainer.appendChild(inputWrapper);
        div.appendChild(imageContainer);
        input.dataset.fieldKey = field.name;
        return div;
      }

      case 'color': {
        // Container for color picker with "use default" option
        const colorContainer = document.createElement('div');
        colorContainer.className = 'd-flex align-items-center gap-2';

        // Checkbox for "use theme default"
        const useDefaultCheck = document.createElement('input');
        useDefaultCheck.type = 'checkbox';
        useDefaultCheck.className = 'form-check-input';
        useDefaultCheck.id = 'color_default_' + field.name;
        useDefaultCheck.checked = !value || value === '';

        const useDefaultLabel = document.createElement('label');
        useDefaultLabel.className = 'form-check-label small text-muted';
        useDefaultLabel.htmlFor = useDefaultCheck.id;
        useDefaultLabel.textContent = 'Use theme';

        input = document.createElement('input');
        input.type = 'color';
        input.className = 'form-control form-control-color';
        input.value = value || '#000000';
        input.disabled = useDefaultCheck.checked;
        input.style.opacity = useDefaultCheck.checked ? '0.5' : '1';

        // Store empty value for theme default
        input.dataset.useDefault = useDefaultCheck.checked ? 'true' : 'false';

        useDefaultCheck.onchange = () => {
          input.disabled = useDefaultCheck.checked;
          input.style.opacity = useDefaultCheck.checked ? '0.5' : '1';
          input.dataset.useDefault = useDefaultCheck.checked ? 'true' : 'false';
        };

        colorContainer.appendChild(input);
        colorContainer.appendChild(useDefaultCheck);
        colorContainer.appendChild(useDefaultLabel);
        input.dataset.fieldKey = field.name;
        div.appendChild(colorContainer);
        return div;
      }

      case 'checkbox': {
        input = document.createElement('input');
        input.type = 'checkbox';
        input.className = 'form-check-input';
        input.checked = value === true || value === 'true';
        const checkDiv = document.createElement('div');
        checkDiv.className = 'form-check';
        checkDiv.appendChild(input);
        const checkLabel = document.createElement('label');
        checkLabel.className = 'form-check-label';
        checkLabel.textContent = field.label;
        if (field.tooltip) {
          const tooltipIcon = document.createElement('span');
          tooltipIcon.className = 'ms-1 text-muted tooltip-trigger';
          tooltipIcon.innerHTML = '<i class="bi bi-info-circle"></i>';
          tooltipIcon.dataset.tooltip = field.tooltip;
          checkLabel.appendChild(tooltipIcon);
        }
        checkDiv.appendChild(checkLabel);
        div.innerHTML = '';
        div.appendChild(checkDiv);
        input.dataset.fieldKey = field.name;
        return div;
      }

      case 'imagelist': {
        // Multi-image selector for galleries
        const imageListContainer = document.createElement('div');
        imageListContainer.className = 'imagelist-container';
        imageListContainer.dataset.fieldKey = field.name;

        // Grid of current images
        const imageListGrid = document.createElement('div');
        imageListGrid.className = 'row row-cols-4 g-2 mb-2';

        const imageList = Array.isArray(value) ? value : [];
        imageList.forEach((imgUrl, idx) => {
          imageListGrid.appendChild(createImageListItem(imgUrl, idx, imageListGrid, imageListContainer));
        });
        imageListContainer.appendChild(imageListGrid);

        // Add image button
        const addImageBtn = document.createElement('button');
        addImageBtn.type = 'button';
        addImageBtn.className = 'btn btn-outline-primary';
        addImageBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Add Images';
        addImageBtn.onclick = () => openImageBrowserForList(imageListGrid, imageListContainer);
        imageListContainer.appendChild(addImageBtn);

        div.appendChild(imageListContainer);
        return div;
      }

      case 'componentslot': {
        const slotContainer = document.createElement('div');
        slotContainer.className = 'componentslot-container border rounded p-2';
        slotContainer.dataset.fieldKey = field.name;
        slotContainer.dataset.allowedCategories = JSON.stringify(field.allowed_categories || []);

        // Initialize _nestedComponents with existing data (deep copy to avoid mutations)
        const slotComponents = Array.isArray(value) ? JSON.parse(JSON.stringify(value)) : [];
        slotContainer._nestedComponents = slotComponents;

        // List of nested components
        const slotList = document.createElement('div');
        slotList.className = 'slot-component-list mb-2';

        slotComponents.forEach((nestedComp, idx) => {
          slotList.appendChild(createNestedComponentItem(nestedComp, idx, field.name));
        });
        slotContainer.appendChild(slotList);

        // Empty state
        if (slotComponents.length === 0) {
          const emptyMsg = document.createElement('p');
          emptyMsg.className = 'text-muted small mb-2 empty-slot-message';
          emptyMsg.textContent = 'No components yet';
          slotList.appendChild(emptyMsg);
        }

        // Add component button
        const addSlotBtn = document.createElement('button');
        addSlotBtn.type = 'button';
        addSlotBtn.className = 'btn btn-sm btn-outline-primary';
        addSlotBtn.innerHTML = '<i class="bi bi-plus"></i> Add Component';
        addSlotBtn.onclick = () => openNestedComponentPicker(field.name, field.allowed_categories || []);
        slotContainer.appendChild(addSlotBtn);

        div.appendChild(slotContainer);
        return div;
      }

      case 'array': {
        const arrayContainer = document.createElement('div');
        arrayContainer.className = 'array-field-container';
        arrayContainer.dataset.fieldKey = field.name;

        const items = Array.isArray(value) ? value : [];
        items.forEach((item, idx) => {
          arrayContainer.appendChild(createArrayItemEditor(field, item, idx));
        });

        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'btn btn-sm btn-outline-primary mt-2';
        addBtn.innerHTML = '<i class="bi bi-plus"></i> Add Item';
        addBtn.onclick = () => {
          const newItem = {};
          (field.item_fields || []).forEach(f => {
            newItem[f.key] = f.default || '';
          });
          const newEl = createArrayItemEditor(field, newItem, arrayContainer.querySelectorAll('.array-item').length);
          arrayContainer.insertBefore(newEl, addBtn);
        };
        arrayContainer.appendChild(addBtn);

        div.appendChild(arrayContainer);
        return div;
      }

      case 'mapPins': {
        // Interactive map editor for pins
        const mapEditorContainer = document.createElement('div');
        mapEditorContainer.className = 'map-editor-container';
        mapEditorContainer.dataset.fieldKey = field.name;

        // Store pins data on the container
        const pinsData = Array.isArray(value) ? JSON.parse(JSON.stringify(value)) : [];
        mapEditorContainer._pinsData = pinsData;

        // Address search
        const searchWrapper = document.createElement('div');
        searchWrapper.className = 'map-address-search mb-2';
        searchWrapper.innerHTML = `
          <div class="input-group">
            <input type="text" class="form-control" id="mapAddressSearch" placeholder="Search address to add pin...">
            <button class="btn btn-outline-secondary" type="button" id="mapAddressSearchBtn">
              <i class="bi bi-search"></i>
            </button>
          </div>
          <div id="mapAddressResults" class="list-group position-absolute w-100" style="z-index:1050;max-height:200px;overflow-y:auto;display:none;"></div>
        `;
        searchWrapper.style.position = 'relative';
        mapEditorContainer.appendChild(searchWrapper);

        // Map display
        const mapWrapper = document.createElement('div');
        mapWrapper.className = 'map-editor-wrapper mb-3';
        mapWrapper.innerHTML = `
          <div class="map-editor-map" style="height: 300px; border: 1px solid #dee2e6; border-radius: 4px;"></div>
          <small class="text-muted d-block mt-1"><i class="bi bi-info-circle"></i> Right-click on the map to add a pin. Click a pin to edit it.</small>
        `;
        mapEditorContainer.appendChild(mapWrapper);

        // Pin list
        const pinListContainer = document.createElement('div');
        pinListContainer.className = 'map-pin-list';
        mapEditorContainer.appendChild(pinListContainer);

        // Initialize map - wait for modal to be fully shown
        const initMap = () => {
          const mapEl = mapWrapper.querySelector('.map-editor-map');
          if (!mapEl || mapEl._leafletMap) return;

          // Get center coordinates from component data (defaults show all of US including AK/HI)
          const centerLat = parseFloat(currentEditingComponent.data.center_lat) || 40.0;
          const centerLng = parseFloat(currentEditingComponent.data.center_lng) || -117.0;
          const zoom = parseInt(currentEditingComponent.data.zoom_level) || 3;

          // Initialize Leaflet map
          const map = L.map(mapEl, {
            fadeAnimation: false,
            zoomAnimation: false
          }).setView([centerLat, centerLng], zoom);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
          mapEl._leafletMap = map;
          mapEl._markers = [];

          // Force map to recalculate its size
          setTimeout(() => map.invalidateSize(), 50);

          // Address search functionality using Nominatim
          const searchInput = searchWrapper.querySelector('#mapAddressSearch');
          const searchBtn = searchWrapper.querySelector('#mapAddressSearchBtn');
          const resultsDiv = searchWrapper.querySelector('#mapAddressResults');

          const searchAddress = async () => {
            const query = searchInput.value.trim();
            if (!query) return;

            searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            try {
              const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`, {
                headers: { 'User-Agent': 'SiteBuilder/1.0' }
              });
              const results = await response.json();

              if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="list-group-item text-muted">No results found</div>';
              } else {
                resultsDiv.innerHTML = results.map(r => `
                  <button type="button" class="list-group-item list-group-item-action"
                          data-lat="${r.lat}" data-lng="${r.lon}" data-name="${r.display_name.split(',')[0]}">
                    <i class="bi bi-geo-alt me-2"></i>${r.display_name}
                  </button>
                `).join('');

                resultsDiv.querySelectorAll('button').forEach(btn => {
                  btn.addEventListener('click', () => {
                    const lat = btn.dataset.lat;
                    const lng = btn.dataset.lng;
                    const name = btn.dataset.name;

                    // Add pin at this location
                    const newPin = {
                      title: name,
                      description: '',
                      lat: parseFloat(lat).toFixed(6),
                      lng: parseFloat(lng).toFixed(6),
                      images: []
                    };
                    pinsData.push(newPin);

                    // Pan to location and render
                    map.setView([lat, lng], 14);
                    renderPins();

                    // Open editor for the new pin
                    openPinEditor(pinsData.length - 1);

                    // Clear search
                    searchInput.value = '';
                    resultsDiv.style.display = 'none';
                  });
                });
              }
              resultsDiv.style.display = 'block';
            } catch (err) {
              console.error('Geocoding error:', err);
              resultsDiv.innerHTML = '<div class="list-group-item text-danger">Search failed</div>';
              resultsDiv.style.display = 'block';
            }
            searchBtn.innerHTML = '<i class="bi bi-search"></i>';
          };

          searchBtn.addEventListener('click', searchAddress);
          searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              searchAddress();
            }
          });

          // Hide results when clicking elsewhere
          document.addEventListener('click', (e) => {
            if (!searchWrapper.contains(e.target)) {
              resultsDiv.style.display = 'none';
            }
          });

          // Function to render pins on map and list
          const renderPins = () => {
            // Clear existing markers
            mapEl._markers.forEach(m => map.removeLayer(m));
            mapEl._markers = [];

            // Clear pin list
            pinListContainer.innerHTML = '';

            if (pinsData.length === 0) {
              pinListContainer.innerHTML = '<p class="text-muted small mb-0">No pins added yet. Right-click on the map to add one.</p>';
            }

            pinsData.forEach((pin, idx) => {
              if (pin.lat && pin.lng) {
                const lat = parseFloat(pin.lat);
                const lng = parseFloat(pin.lng);

                // Create marker
                let marker;
                if (pin.images && pin.images.length > 0) {
                  const icon = L.divIcon({
                    className: 'custom-marker',
                    html: '<img src="' + pin.images[0] + '" style="width:32px;height:32px;object-fit:cover;border-radius:50%;border:2px solid var(--site-primary, #0066cc);box-shadow:0 2px 4px rgba(0,0,0,0.3);">',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                  });
                  marker = L.marker([lat, lng], { icon: icon }).addTo(map);
                } else {
                  marker = L.marker([lat, lng]).addTo(map);
                }

                marker.on('click', () => openPinEditor(idx));
                mapEl._markers.push(marker);
              }

              // Create list item
              const listItem = document.createElement('div');
              listItem.className = 'map-pin-item d-flex align-items-center gap-2 p-2 border rounded mb-2';
              listItem.innerHTML = `
                <div class="pin-thumb" style="width:40px;height:40px;flex-shrink:0;">
                  ${pin.images && pin.images.length > 0
                    ? '<img src="' + pin.images[0] + '" style="width:100%;height:100%;object-fit:cover;border-radius:4px;">'
                    : '<div style="width:100%;height:100%;background:#f0f0f0;border-radius:4px;display:flex;align-items:center;justify-content:center;"><i class="bi bi-geo-alt text-muted"></i></div>'}
                </div>
                <div class="flex-grow-1 min-width-0">
                  <div class="fw-medium small text-truncate">${pin.title || 'Untitled Pin'}</div>
                  <div class="text-muted" style="font-size:0.75rem;">${pin.lat ? pin.lat.substring(0,8) : '?'}, ${pin.lng ? pin.lng.substring(0,8) : '?'}</div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="openPinEditor(${idx})" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteMapPin(${idx})" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              `;
              pinListContainer.appendChild(listItem);
            });
          };

          // Right-click to add pin
          map.on('contextmenu', (e) => {
            const newPin = {
              title: '',
              description: '',
              lat: e.latlng.lat.toFixed(6),
              lng: e.latlng.lng.toFixed(6),
              images: []
            };
            pinsData.push(newPin);
            renderPins();
            openPinEditor(pinsData.length - 1);
          });

          // Update center when map is moved
          map.on('moveend', () => {
            const center = map.getCenter();
            currentEditingComponent.data.center_lat = center.lat.toFixed(6);
            currentEditingComponent.data.center_lng = center.lng.toFixed(6);
            // Update the text inputs if they exist
            const latInput = document.querySelector('[data-field-key="center_lat"]');
            const lngInput = document.querySelector('[data-field-key="center_lng"]');
            if (latInput) latInput.value = center.lat.toFixed(6);
            if (lngInput) lngInput.value = center.lng.toFixed(6);
          });

          map.on('zoomend', () => {
            currentEditingComponent.data.zoom_level = map.getZoom().toString();
            const zoomSelect = document.querySelector('[data-field-key="zoom_level"]');
            if (zoomSelect) zoomSelect.value = map.getZoom().toString();
          });

          // Store functions on container for access
          mapEditorContainer._renderPins = renderPins;
          mapEditorContainer._map = map;

          // Make functions globally accessible for onclick handlers
          window.openPinEditor = (idx) => {
            openMapPinEditorModal(pinsData, idx, renderPins);
          };
          window.deleteMapPin = (idx) => {
            if (confirm('Delete this pin?')) {
              pinsData.splice(idx, 1);
              renderPins();
            }
          };

          renderPins();
        };

        // Initialize map when modal is fully shown for proper rendering
        const modalEl = document.getElementById('editComponentModal');
        const onModalShown = () => {
          initMap();
          // Also invalidate size again after a brief delay for any remaining layout shifts
          setTimeout(() => {
            const mapEl = mapWrapper.querySelector('.map-editor-map');
            if (mapEl && mapEl._leafletMap) {
              mapEl._leafletMap.invalidateSize();
            }
          }, 200);
        };
        modalEl.addEventListener('shown.bs.modal', onModalShown, { once: true });

        // Also try to init immediately in case modal is already shown
        setTimeout(initMap, 100);

        div.appendChild(mapEditorContainer);
        return div;
      }

      default: {
        input = document.createElement('input');
        input.type = field.type === 'url' ? 'url' : 'text';
        input.className = 'form-control';
        input.value = value;
        input.dataset.fieldKey = field.name;

        // Add link suggestions for URL fields
        if (field.type === 'url') {
          const wrapper = document.createElement('div');
          wrapper.className = 'position-relative';
          wrapper.appendChild(input);

          const dropdown = document.createElement('div');
          dropdown.className = 'url-suggestions-dropdown';
          dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #dee2e6;border-radius:0 0 4px 4px;box-shadow:0 4px 8px rgba(0,0,0,0.1);z-index:1050;max-height:200px;overflow-y:auto;display:none;';
          wrapper.appendChild(dropdown);

          input.addEventListener('input', async function() {
            const query = this.value.toLowerCase();
            const suggestions = await loadLinkSuggestions();
            const filtered = suggestions.filter(s =>
              s.label.toLowerCase().includes(query) ||
              s.url.toLowerCase().includes(query)
            ).slice(0, 8);

            if (filtered.length === 0) {
              dropdown.style.display = 'none';
              return;
            }

            dropdown.innerHTML = filtered.map(s => `
              <div class="suggestion-item" data-url="${s.url}" style="padding:0.5rem 0.75rem;cursor:pointer;display:flex;align-items:center;gap:0.5rem;font-size:0.875rem;">
                <i class="bi bi-${s.type === 'page' ? 'file-earmark' : 'hash'}"></i>
                <span>${s.label}</span>
                <small style="margin-left:auto;color:#6c757d;">${s.url}</small>
              </div>
            `).join('');
            dropdown.style.display = 'block';

            // Add click handlers
            dropdown.querySelectorAll('.suggestion-item').forEach(item => {
              item.addEventListener('mousedown', function(e) {
                e.preventDefault();
                input.value = this.dataset.url;
                dropdown.style.display = 'none';
              });
              item.addEventListener('mouseenter', function() {
                this.style.background = '#f8f9fa';
              });
              item.addEventListener('mouseleave', function() {
                this.style.background = 'white';
              });
            });
          });

          input.addEventListener('focus', async function() {
            const query = this.value.toLowerCase();
            const suggestions = await loadLinkSuggestions();
            const filtered = suggestions.filter(s =>
              s.label.toLowerCase().includes(query) ||
              s.url.toLowerCase().includes(query)
            ).slice(0, 8);
            if (filtered.length > 0 && query.length > 0) {
              input.dispatchEvent(new Event('input'));
            }
          });

          input.addEventListener('blur', function() {
            setTimeout(() => { dropdown.style.display = 'none'; }, 200);
          });

          div.appendChild(wrapper);
          return div;
        }

        div.appendChild(input);
        return div;
      }
    }
  }

  function createArrayItemEditor(field, item, index) {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'array-item border rounded p-2 mb-2';
    itemDiv.dataset.index = index;

    const header = document.createElement('div');
    header.className = 'd-flex justify-content-between align-items-center mb-2';
    header.innerHTML = `
      <span class="small text-muted">Item ${index + 1}</span>
      <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.array-item').remove()">
        <i class="bi bi-x"></i>
      </button>
    `;
    itemDiv.appendChild(header);

    (field.item_fields || []).forEach(subField => {
      const subDiv = document.createElement('div');
      subDiv.className = 'mb-2';

      const subLabel = document.createElement('label');
      subLabel.className = 'form-label small';
      subLabel.textContent = subField.label;
      subDiv.appendChild(subLabel);

      const subInput = document.createElement('input');
      subInput.type = 'text';
      subInput.className = 'form-control form-control-sm';
      subInput.value = item[subField.key] || '';
      subInput.dataset.subFieldKey = subField.key;
      subDiv.appendChild(subInput);

      itemDiv.appendChild(subDiv);
    });

    return itemDiv;
  }

  function saveComponentEdits() {
    const body = document.getElementById('editComponentBody');

    // Regular fields (exclude containers that are handled separately)
    console.log('=== Saving component edits ===');
    const allFieldElements = body.querySelectorAll('[data-field-key]:not(.imagelist-container):not(.array-field-container):not(.componentslot-container):not(.richtext-editor-container)');
    console.log('Found', allFieldElements.length, 'field elements');
    allFieldElements.forEach(input => {
      const key = input.dataset.fieldKey;
      if (!key) return; // Skip elements with empty field key
      if (input.type === 'checkbox') {
        currentEditingComponent.data[key] = input.checked;
        console.log('Saved checkbox:', key, '=', input.checked);
      } else if (input.type === 'color') {
        // Check if "use theme default" is checked
        if (input.dataset.useDefault === 'true') {
          currentEditingComponent.data[key] = '';
          console.log('Saved color (theme default):', key, '= ""');
        } else {
          currentEditingComponent.data[key] = input.value;
          console.log('Saved color:', key, '=', input.value);
        }
      } else {
        currentEditingComponent.data[key] = input.value;
        console.log('Saved field:', key, '=', input.value, '(type:', input.type, ')');
      }
    });
    console.log('Final component data:', JSON.stringify(currentEditingComponent.data, null, 2));

    // Image list fields (for gallery component)
    body.querySelectorAll('.imagelist-container').forEach(container => {
      const key = container.dataset.fieldKey;
      const images = [];
      container.querySelectorAll('.image-thumb[data-image-url]').forEach(thumb => {
        images.push(thumb.dataset.imageUrl);
      });
      currentEditingComponent.data[key] = images;
    });

    // Array fields
    body.querySelectorAll('.array-field-container').forEach(container => {
      const key = container.dataset.fieldKey;
      const items = [];
      container.querySelectorAll('.array-item').forEach(itemEl => {
        const item = {};
        itemEl.querySelectorAll('[data-sub-field-key]').forEach(input => {
          item[input.dataset.subFieldKey] = input.value;
        });
        if (Object.keys(item).length > 0) {
          items.push(item);
        }
      });
      currentEditingComponent.data[key] = items;
    });

    // Component slot fields (for two-column and other container components)
    body.querySelectorAll('.componentslot-container').forEach(container => {
      const key = container.dataset.fieldKey;
      currentEditingComponent.data[key] = container._nestedComponents || [];
    });

    // Rich text fields
    body.querySelectorAll('.richtext-editor-container').forEach(container => {
      const key = container.dataset.fieldKey;
      const editor = container.querySelector('.richtext-editor');
      if (editor) {
        currentEditingComponent.data[key] = editor.innerHTML;
      }
    });

    // Map pins fields
    body.querySelectorAll('.map-editor-container').forEach(container => {
      const key = container.dataset.fieldKey;
      if (container._pinsData) {
        currentEditingComponent.data[key] = container._pinsData;
      }
    });

    pageData.slots[currentEditingSlot][currentEditingIndex] = currentEditingComponent;
    renderSlot(currentEditingSlot);
    refreshPreview();
    editModal.hide();
    showToast('Component updated');
  }

  function deleteCurrentComponent() {
    if (confirm('Are you sure you want to delete this component?')) {
      pageData.slots[currentEditingSlot].splice(currentEditingIndex, 1);
      renderSlot(currentEditingSlot);
      refreshPreview();
      editModal.hide();
    }
  }

  function removeComponent(slotName, index) {
    if (confirm('Remove this component?')) {
      pageData.slots[slotName].splice(index, 1);
      renderSlot(slotName);
      refreshPreview();
    }
  }

  function duplicateComponent(slotName, index) {
    const original = pageData.slots[slotName][index];
    // Deep copy the component
    const copy = JSON.parse(JSON.stringify(original));
    // Generate new unique ID
    copy.id = 'comp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

    // Generate new anchor_id if the component has one
    const compDef = componentsLib.find(c => c.id === copy.type);
    if (compDef && compDef.editable_fields.some(f => f.name === 'anchor_id')) {
      copy.data.anchor_id = generateComponentAnchorId(copy.type);
    }

    // Insert copy right after the original
    pageData.slots[slotName].splice(index + 1, 0, copy);
    renderSlot(slotName);
    refreshPreview();

    const compName = compDef ? compDef.name : copy.type;
    showToast(`Duplicated "${compName}"`);
  }

  function initDragAndDrop() {
    document.querySelectorAll('.slot-content').forEach(slot => {
      slot.addEventListener('dragover', handleDragOver);
      slot.addEventListener('drop', handleDrop);
      slot.addEventListener('dragleave', handleDragLeave);
    });

    document.addEventListener('dragstart', handleDragStart);
    document.addEventListener('dragend', handleDragEnd);
  }

  let draggedElement = null;
  let draggedSlot = null;
  let draggedIndex = null;

  function handleDragStart(e) {
    if (!e.target.classList.contains('page-component')) return;
    draggedElement = e.target;
    draggedSlot = e.target.dataset.slot;
    draggedIndex = parseInt(e.target.dataset.index);
    e.target.classList.add('dragging');
  }

  function handleDragEnd(e) {
    if (!e.target.classList.contains('page-component')) return;
    e.target.classList.remove('dragging');
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
  }

  function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
  }

  function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
  }

  function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');

    if (!draggedElement) return;

    const targetSlot = e.currentTarget.id.replace('slot-', '');

    // Remove from old position
    const component = pageData.slots[draggedSlot].splice(draggedIndex, 1)[0];

    // Determine target index
    let targetIndex = pageData.slots[targetSlot]?.length || 0;
    const targetComponent = e.target && e.target.closest ? e.target.closest('.page-component') : null;
    if (targetComponent) {
      targetIndex = parseInt(targetComponent.dataset.index);
      if (draggedSlot === targetSlot && draggedIndex < targetIndex) {
        targetIndex--;
      }
    }

    // Add to new position
    if (!pageData.slots[targetSlot]) {
      pageData.slots[targetSlot] = [];
    }
    pageData.slots[targetSlot].splice(targetIndex, 0, component);

    renderSlot(draggedSlot);
    if (draggedSlot !== targetSlot) {
      renderSlot(targetSlot);
    }
    refreshPreview();

    draggedElement = null;
    draggedSlot = null;
    draggedIndex = null;
  }

  // Tooltip Functions
  function initTooltips() {
    // Use event delegation for tooltips
    document.addEventListener('mouseenter', function(e) {
      if (!e.target || !e.target.closest) return;
      const trigger = e.target.closest('.tooltip-trigger');
      if (!trigger) return;

      const tooltipText = trigger.dataset.tooltip;
      if (!tooltipText) return;

      // Remove any existing tooltip
      const existing = document.querySelector('.custom-tooltip');
      if (existing) existing.remove();

      // Create tooltip
      const tooltip = document.createElement('div');
      tooltip.className = 'custom-tooltip';
      tooltip.textContent = tooltipText;
      document.body.appendChild(tooltip);

      // Position tooltip
      const rect = trigger.getBoundingClientRect();
      tooltip.style.top = (rect.bottom + 10) + 'px';
      tooltip.style.left = Math.max(10, Math.min(rect.left - 10, window.innerWidth - tooltip.offsetWidth - 10)) + 'px';
    }, true);

    document.addEventListener('mouseleave', function(e) {
      if (!e.target || !e.target.closest) return;
      const trigger = e.target.closest('.tooltip-trigger');
      if (!trigger) return;

      const tooltip = document.querySelector('.custom-tooltip');
      if (tooltip) tooltip.remove();
    }, true);
  }

  // Image Browser Functions
  let imageBrowserModal;
  let currentImageInput = null;
  let currentImagePreview = null;

  function initImageBrowser() {
    imageBrowserModal = new bootstrap.Modal(document.getElementById('imageBrowserModal'));

    // Setup drag & drop on dropzone
    const dropzone = document.getElementById('imageDropzone');
    const fileInput = document.getElementById('imageUploadInput');

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('drag-over');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('drag-over');
    });

    dropzone.addEventListener('drop', async (e) => {
      e.preventDefault();
      dropzone.classList.remove('drag-over');
      if (e.dataTransfer.files.length > 0) {
        await uploadImageFromBrowser(e.dataTransfer.files[0]);
      }
    });

    fileInput.addEventListener('change', async (e) => {
      if (e.target.files.length > 0) {
        await uploadImageFromBrowser(e.target.files[0]);
        e.target.value = ''; // Reset for next upload
      }
    });
  }

  async function openImageBrowser(inputElement, previewElement) {
    currentImageInput = inputElement;
    currentImagePreview = previewElement;

    // Load existing images
    await loadImageGrid();

    imageBrowserModal.show();
  }

  async function loadImageGrid() {
    const grid = document.getElementById('imageGrid');
    grid.innerHTML = '<div class="col-12 text-center text-muted py-4"><i class="bi bi-hourglass-split"></i> Loading...</div>';

    try {
      const response = await fetch('/builder/assets');
      const data = await response.json();

      if (data.images && data.images.length > 0) {
        grid.innerHTML = '';
        data.images.forEach(img => {
          const col = document.createElement('div');
          col.className = 'col';

          const thumb = document.createElement('div');
          thumb.className = 'image-thumb position-relative';
          thumb.dataset.imageUrl = img.full_url;
          // Use full_url for both preview and storage to ensure it works in srcdoc iframe
          thumb.onclick = () => selectImage(img.full_url, thumb);

          const imgEl = document.createElement('img');
          imgEl.src = img.full_url;
          imgEl.alt = img.name;
          imgEl.loading = 'lazy';

          const nameEl = document.createElement('div');
          nameEl.className = 'image-name';
          nameEl.textContent = img.name;

          thumb.appendChild(imgEl);
          thumb.appendChild(nameEl);
          col.appendChild(thumb);
          grid.appendChild(col);
        });
      } else {
        grid.innerHTML = '<div class="col-12 text-center text-muted py-4"><i class="bi bi-image"></i> No images found. Upload one above!</div>';
      }
    } catch (error) {
      grid.innerHTML = '<div class="col-12 text-center text-danger py-4"><i class="bi bi-exclamation-triangle"></i> Error loading images</div>';
      console.error('Error loading images:', error);
    }
  }

  function selectImage(url) {
    if (currentImageInput) {
      currentImageInput.value = url;
      if (currentImagePreview) {
        currentImagePreview.src = url;
      }
    }
    imageBrowserModal.hide();
    showToast('Image selected');
  }

  async function uploadImageFromBrowser(file) {
    // Validate
    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
    if (!validTypes.includes(file.type)) {
      showToast('Invalid file type. Use JPG, PNG, GIF, WebP, or SVG.', 'danger');
      return;
    }

    const progress = document.getElementById('uploadProgress');
    progress.style.display = 'block';

    try {
      const formData = new FormData();
      formData.append('file', file);

      const response = await fetch('/builder/assets/upload', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        showToast('Image uploaded successfully');
        // Reload the grid to show the new image
        await loadImageGrid();
        // Select the newly uploaded image (handles both single and list modes)
        selectImage(data.url);
      } else {
        showToast('Upload failed: ' + data.error, 'danger');
      }
    } catch (error) {
      showToast('Upload error: ' + error.message, 'danger');
    } finally {
      progress.style.display = 'none';
    }
  }

  // Image List Functions for Gallery Component
  let currentImageListGrid = null;
  let currentImageListContainer = null;
  let pendingImageSelections = []; // Track selections before submitting

  function createImageListItem(imgUrl, idx, gridElement, containerElement) {
    const col = document.createElement('div');
    col.className = 'col';
    col.dataset.imageIndex = idx;

    const thumb = document.createElement('div');
    thumb.className = 'image-thumb position-relative';
    thumb.style.aspectRatio = '1';

    const imgEl = document.createElement('img');
    // URLs should already be full URLs (https://domain/...)
    imgEl.src = imgUrl;
    imgEl.alt = `Gallery image ${idx + 1}`;
    imgEl.loading = 'lazy';
    imgEl.onerror = () => {
      imgEl.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect fill="%23f0f0f0" width="80" height="80"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23999" font-size="10">Error</text></svg>';
    };

    // Store the full URL
    thumb.dataset.imageUrl = imgUrl;

    // Delete button overlay
    const deleteBtn = document.createElement('button');
    deleteBtn.type = 'button';
    deleteBtn.className = 'btn btn-sm btn-danger position-absolute';
    deleteBtn.style.cssText = 'top: 4px; right: 4px; padding: 2px 6px; font-size: 0.7rem;';
    deleteBtn.innerHTML = '<i class="bi bi-x"></i>';
    deleteBtn.onclick = (e) => {
      e.stopPropagation();
      col.remove();
      // Re-index remaining items
      gridElement.querySelectorAll('[data-image-index]').forEach((item, newIdx) => {
        item.dataset.imageIndex = newIdx;
      });
    };

    thumb.appendChild(imgEl);
    thumb.appendChild(deleteBtn);
    col.appendChild(thumb);

    return col;
  }

  function openImageBrowserForList(gridElement, containerElement) {
    currentImageListGrid = gridElement;
    currentImageListContainer = containerElement;
    pendingImageSelections = []; // Reset pending selections

    // Set a flag to indicate we're in multi-select mode
    imageBrowserModal._isListMode = true;

    // Update UI for list mode
    document.getElementById('imageListModeHint').style.display = 'inline';
    document.getElementById('imageBrowserCancelBtn').querySelector('#imageBrowserCancelText').textContent = 'Cancel';
    document.getElementById('imageBrowserDoneBtn').style.display = 'inline-block';
    updateSelectionCount();

    loadImageGrid();
    imageBrowserModal.show();
  }

  function toggleImageSelection(url, thumbElement) {
    const idx = pendingImageSelections.indexOf(url);
    if (idx > -1) {
      // Deselect
      pendingImageSelections.splice(idx, 1);
      thumbElement.classList.remove('selected');
      const badge = thumbElement.querySelector('.selection-badge');
      if (badge) badge.remove();
    } else {
      // Select
      pendingImageSelections.push(url);
      thumbElement.classList.add('selected');
      // Add numbered badge
      const badge = document.createElement('div');
      badge.className = 'selection-badge';
      badge.textContent = pendingImageSelections.length;
      thumbElement.appendChild(badge);
    }
    // Update all badges with correct numbers
    updateSelectionBadges();
    updateSelectionCount();
  }

  function updateSelectionBadges() {
    const grid = document.getElementById('imageGrid');
    grid.querySelectorAll('.image-thumb.selected').forEach(thumb => {
      const url = thumb.dataset.imageUrl;
      const idx = pendingImageSelections.indexOf(url);
      const badge = thumb.querySelector('.selection-badge');
      if (badge && idx > -1) {
        badge.textContent = idx + 1;
      }
    });
  }

  function updateSelectionCount() {
    const hint = document.getElementById('imageListModeHint');
    if (pendingImageSelections.length > 0) {
      hint.innerHTML = `<i class="bi bi-check-circle text-success"></i> ${pendingImageSelections.length} image${pendingImageSelections.length > 1 ? 's' : ''} selected - click Done to add`;
    } else {
      hint.innerHTML = '<i class="bi bi-info-circle"></i> Click images to select them for gallery';
    }
  }

  function submitImageSelections() {
    if (currentImageListGrid && currentImageListContainer && pendingImageSelections.length > 0) {
      pendingImageSelections.forEach(url => {
        const existingCount = currentImageListGrid.querySelectorAll('[data-image-index]').length;
        const newItem = createImageListItem(url, existingCount, currentImageListGrid, currentImageListContainer);
        currentImageListGrid.appendChild(newItem);
      });
      showToast(`Added ${pendingImageSelections.length} image${pendingImageSelections.length > 1 ? 's' : ''} to gallery`);
    }
    imageBrowserModal.hide();
  }

  // Override selectImage to check if we're in list mode
  const originalSelectImage = selectImage;
  selectImage = function(url, thumbElement) {
    if (imageBrowserModal._isListMode) {
      toggleImageSelection(url, thumbElement);
    } else {
      originalSelectImage(url);
    }
  };

  // Reset list mode when modal is hidden
  document.getElementById('imageBrowserModal').addEventListener('hidden.bs.modal', function() {
    imageBrowserModal._isListMode = false;
    currentImageListGrid = null;
    currentImageListContainer = null;
    pendingImageSelections = [];

    // Reset UI
    document.getElementById('imageListModeHint').style.display = 'none';
    document.getElementById('imageBrowserDoneBtn').style.display = 'none';

    // Clear selection styling
    document.querySelectorAll('#imageGrid .image-thumb.selected').forEach(thumb => {
      thumb.classList.remove('selected');
      const badge = thumb.querySelector('.selection-badge');
      if (badge) badge.remove();
    });
  });

  // Nested Component Functions for Two-Column and other slot-based components
  let currentNestedSlotName = null;
  let currentNestedSlotCategories = [];

  function createNestedComponentItem(nestedComp, idx, slotName) {
    const compDef = componentsLib.find(c => c.id === nestedComp.type);
    const compName = compDef ? compDef.name : nestedComp.type;

    const item = document.createElement('div');
    item.className = 'nested-component-item d-flex justify-content-between align-items-center p-2 mb-1 border rounded bg-light';
    item.dataset.nestedIndex = idx;
    item.dataset.slotName = slotName;

    item.innerHTML = `
      <div class="d-flex align-items-center">
        <i class="bi bi-grip-vertical text-muted me-2"></i>
        <span class="small fw-medium">${compName}</span>
        <span class="text-muted small ms-2">${getNestedComponentPreview(nestedComp)}</span>
      </div>
      <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-outline-secondary" onclick="duplicateNestedComponent('${slotName}', ${idx})" title="Duplicate">
          <i class="bi bi-copy"></i>
        </button>
        <button type="button" class="btn btn-outline-primary" onclick="editNestedComponent('${slotName}', ${idx})" title="Edit">
          <i class="bi bi-pencil"></i>
        </button>
        <button type="button" class="btn btn-outline-danger" onclick="removeNestedComponent('${slotName}', ${idx})" title="Remove">
          <i class="bi bi-x"></i>
        </button>
      </div>
    `;

    return item;
  }

  function getNestedComponentPreview(comp) {
    if (comp.data.title) return comp.data.title.substring(0, 20) + (comp.data.title.length > 20 ? '...' : '');
    if (comp.data.heading) return comp.data.heading.substring(0, 20) + (comp.data.heading.length > 20 ? '...' : '');
    return '';
  }

  function openNestedComponentPicker(slotName, allowedCategories) {
    currentNestedSlotName = slotName;
    currentNestedSlotCategories = allowedCategories;

    // Build list of allowed components
    const allowedComponents = componentsLib.filter(c => {
      // Exclude navigation, footer, sidebar - they shouldn't be nested
      if (['navigation', 'footer', 'sidebar'].includes(c.category)) return false;
      // Exclude components that have slots (like two-column) to prevent deep nesting
      if (c.has_slots) return false;
      // If no categories specified, allow all non-excluded
      if (!allowedCategories || allowedCategories.length === 0) return true;
      return allowedCategories.includes(c.category);
    });

    // Create picker modal content
    let modalContent = `
      <div class="modal fade" id="nestedComponentPickerModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-plus-square"></i> Add Component to ${slotName.replace('_', ' ')}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="list-group">
    `;

    allowedComponents.forEach(comp => {
      modalContent += `
        <button type="button" class="list-group-item list-group-item-action" onclick="addNestedComponent('${comp.id}')">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${comp.name}</strong>
              <div class="text-muted small">${comp.description}</div>
            </div>
            <i class="bi bi-plus-circle text-success"></i>
          </div>
        </button>
      `;
    });

    modalContent += `
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    // Remove existing picker modal if any
    const existingPicker = document.getElementById('nestedComponentPickerModal');
    if (existingPicker) existingPicker.remove();

    // Add new modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalContent);

    // Show the modal
    const pickerModal = new bootstrap.Modal(document.getElementById('nestedComponentPickerModal'));
    pickerModal.show();
  }

  function addNestedComponent(componentId) {
    const compDef = componentsLib.find(c => c.id === componentId);
    if (!compDef) return;

    // Create new component with default data
    const newComponent = {
      id: 'nested-' + Date.now(),
      type: componentId,
      data: JSON.parse(JSON.stringify(compDef.default_data))
    };

    // Auto-generate anchor_id if the component has that field
    if (compDef.editable_fields.some(f => f.name === 'anchor_id')) {
      newComponent.data.anchor_id = generateComponentAnchorId(componentId);
    }

    // Find the slot container in the edit modal
    const slotContainer = document.querySelector(`.componentslot-container[data-field-key="${currentNestedSlotName}"]`);
    if (slotContainer) {
      const slotList = slotContainer.querySelector('.slot-component-list');

      // Remove empty message if present
      const emptyMsg = slotList.querySelector('.empty-slot-message');
      if (emptyMsg) emptyMsg.remove();

      // Count existing items
      const existingCount = slotList.querySelectorAll('.nested-component-item').length;

      // Add the new component to the list
      slotList.appendChild(createNestedComponentItem(newComponent, existingCount, currentNestedSlotName));

      // Store the actual component data
      if (!slotContainer._nestedComponents) {
        slotContainer._nestedComponents = [];
      }
      slotContainer._nestedComponents.push(newComponent);
    }

    // Close the picker modal
    const pickerModal = bootstrap.Modal.getInstance(document.getElementById('nestedComponentPickerModal'));
    if (pickerModal) pickerModal.hide();

    showToast(`Added "${compDef.name}" to ${currentNestedSlotName.replace('_', ' ')}`);
  }

  function editNestedComponent(slotName, idx) {
    const slotContainer = document.querySelector(`.componentslot-container[data-field-key="${slotName}"]`);
    if (!slotContainer || !slotContainer._nestedComponents) return;

    const nestedComp = slotContainer._nestedComponents[idx];
    if (!nestedComp) return;

    const compDef = componentsLib.find(c => c.id === nestedComp.type);
    if (!compDef) return;

    // Build a nested edit modal - use modal-lg for components with sections
    const modalSize = compDef.has_sections ? 'modal-lg' : '';
    let editContent = `
      <div class="modal fade" id="nestedEditModal" tabindex="-1">
        <div class="modal-dialog ${modalSize}">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Edit ${compDef.name}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="nestedEditBody">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" onclick="saveNestedComponentEdits('${slotName}', ${idx})">Save</button>
            </div>
          </div>
        </div>
      </div>
    `;

    // Remove existing modal if any
    const existingModal = document.getElementById('nestedEditModal');
    if (existingModal) existingModal.remove();

    document.body.insertAdjacentHTML('beforeend', editContent);

    // Build form fields - handle sections same as editComponent
    const body = document.getElementById('nestedEditBody');

    if (compDef.has_sections) {
      // Group fields by section, preserving order
      const sections = {};
      const sectionOrder = [];
      const noSection = [];

      compDef.editable_fields.forEach(field => {
        // Skip componentslot fields to prevent further nesting
        if (field.type === 'componentslot') return;

        if (field.section) {
          if (!sections[field.section]) {
            sections[field.section] = [];
            sectionOrder.push(field.section);
          }
          sections[field.section].push(field);
        } else {
          noSection.push(field);
        }
      });

      // Render each section in order
      sectionOrder.forEach(sectionName => {
        const sectionFields = sections[sectionName];
        const toggleField = sectionFields.find(f => f.type === 'section_toggle');
        const otherFields = sectionFields.filter(f => f.type !== 'section_toggle');

        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'component-section mb-3 border rounded';

        // Section header with separate collapse and enable controls
        const header = document.createElement('div');
        header.className = 'section-header d-flex align-items-center p-2 bg-light rounded-top';

        // Collapse/expand icon (left side) - starts collapsed
        const collapseBtn = document.createElement('button');
        collapseBtn.type = 'button';
        collapseBtn.className = 'btn btn-sm btn-link p-0 me-2 text-muted';
        collapseBtn.innerHTML = '<i class="bi bi-chevron-right"></i>';
        collapseBtn.title = 'Collapse/Expand';

        // Enable checkbox (separate from collapse)
        const toggleValue = toggleField ? (nestedComp.data[toggleField.name] !== undefined ? nestedComp.data[toggleField.name] : toggleField.default) : true;
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input me-2';
        checkbox.checked = toggleValue === true || toggleValue === 'true';
        checkbox.dataset.fieldKey = toggleField ? toggleField.name : '';
        checkbox.id = 'nested_section_enable_' + sectionName;
        checkbox.title = 'Enable/Disable this section';

        const headerLabel = document.createElement('label');
        headerLabel.className = 'form-check-label fw-medium flex-grow-1 mb-0';
        headerLabel.htmlFor = checkbox.id;
        headerLabel.textContent = toggleField ? toggleField.label : sectionName;
        headerLabel.style.cursor = 'pointer';

        header.appendChild(collapseBtn);
        header.appendChild(checkbox);
        header.appendChild(headerLabel);
        sectionDiv.appendChild(header);

        // Section content (collapsible) - starts collapsed
        const content = document.createElement('div');
        content.className = 'section-content p-2';
        content.style.display = 'none'; // Start collapsed

        otherFields.forEach(field => {
          const value = nestedComp.data[field.name] !== undefined ? nestedComp.data[field.name] : (field.default !== undefined ? field.default : '');
          content.appendChild(createFieldEditor(field, value));
        });

        sectionDiv.appendChild(content);

        // Collapse button only controls visibility (not enable/disable)
        const toggleCollapse = () => {
          const isCollapsed = content.style.display === 'none';
          content.style.display = isCollapsed ? 'block' : 'none';
          collapseBtn.innerHTML = isCollapsed ? '<i class="bi bi-chevron-down"></i>' : '<i class="bi bi-chevron-right"></i>';
        };

        collapseBtn.onclick = (e) => {
          e.stopPropagation();
          toggleCollapse();
        };

        // Clicking the label also toggles collapse
        headerLabel.onclick = (e) => {
          if (e.target === checkbox) return;
          toggleCollapse();
        };

        // Visual feedback when section is disabled
        const updateDisabledState = () => {
          content.style.opacity = checkbox.checked ? '1' : '0.5';
          headerLabel.style.textDecoration = checkbox.checked ? 'none' : 'line-through';
        };
        checkbox.onchange = () => {
          updateDisabledState();
          // Auto-initialize timestamp field when timestamp section is enabled
          if (checkbox.checked && sectionName === 'timestamp') {
            const datetimeInput = content.querySelector('input[type="datetime-local"]');
            if (datetimeInput && !datetimeInput.value) {
              // Set to current date/time
              const now = new Date();
              datetimeInput.value = now.toISOString().substring(0, 16);
            }
          }
        };
        updateDisabledState();

        body.appendChild(sectionDiv);
      });

      // Render fields without section
      noSection.forEach(field => {
        const value = nestedComp.data[field.name] !== undefined ? nestedComp.data[field.name] : (field.default !== undefined ? field.default : '');
        body.appendChild(createFieldEditor(field, value));
      });
    } else {
      // No sections - render fields normally
      compDef.editable_fields.forEach(field => {
        // Skip componentslot fields to prevent further nesting
        if (field.type === 'componentslot') return;

        const value = nestedComp.data[field.name] !== undefined ? nestedComp.data[field.name] : (field.default !== undefined ? field.default : '');
        body.appendChild(createFieldEditor(field, value));
      });
    }

    const nestedModal = new bootstrap.Modal(document.getElementById('nestedEditModal'));
    nestedModal.show();
  }

  function saveNestedComponentEdits(slotName, idx) {
    const slotContainer = document.querySelector(`.componentslot-container[data-field-key="${slotName}"]`);
    if (!slotContainer || !slotContainer._nestedComponents) return;

    const nestedComp = slotContainer._nestedComponents[idx];
    if (!nestedComp) return;

    const body = document.getElementById('nestedEditBody');

    // Collect field values (exclude containers)
    body.querySelectorAll('[data-field-key]:not(.richtext-editor-container):not(.imagelist-container)').forEach(input => {
      const key = input.dataset.fieldKey;
      if (!key) return; // Skip elements with empty field key
      if (input.type === 'checkbox') {
        nestedComp.data[key] = input.checked;
      } else if (input.type === 'color') {
        // Check if "use theme default" is checked
        if (input.dataset.useDefault === 'true') {
          nestedComp.data[key] = '';
        } else {
          nestedComp.data[key] = input.value;
        }
      } else {
        nestedComp.data[key] = input.value;
      }
    });

    // Rich text fields
    body.querySelectorAll('.richtext-editor-container').forEach(container => {
      const key = container.dataset.fieldKey;
      const editor = container.querySelector('.richtext-editor');
      if (editor) {
        nestedComp.data[key] = editor.innerHTML;
      }
    });

    // Image list fields
    body.querySelectorAll('.imagelist-container').forEach(container => {
      const key = container.dataset.fieldKey;
      const images = [];
      container.querySelectorAll('.image-thumb[data-image-url]').forEach(thumb => {
        images.push(thumb.dataset.imageUrl);
      });
      nestedComp.data[key] = images;
    });

    // Update the display
    const slotList = slotContainer.querySelector('.slot-component-list');
    const items = slotList.querySelectorAll('.nested-component-item');
    if (items[idx]) {
      items[idx].replaceWith(createNestedComponentItem(nestedComp, idx, slotName));
    }

    // Close modal
    const nestedModal = bootstrap.Modal.getInstance(document.getElementById('nestedEditModal'));
    if (nestedModal) nestedModal.hide();

    showToast('Component updated');
  }

  function removeNestedComponent(slotName, idx) {
    const slotContainer = document.querySelector(`.componentslot-container[data-field-key="${slotName}"]`);
    if (!slotContainer || !slotContainer._nestedComponents) return;

    // Remove from data
    slotContainer._nestedComponents.splice(idx, 1);

    // Remove from display and re-index
    const slotList = slotContainer.querySelector('.slot-component-list');
    slotList.innerHTML = '';

    if (slotContainer._nestedComponents.length === 0) {
      const emptyMsg = document.createElement('p');
      emptyMsg.className = 'text-muted small mb-2 empty-slot-message';
      emptyMsg.textContent = 'No components yet';
      slotList.appendChild(emptyMsg);
    } else {
      slotContainer._nestedComponents.forEach((comp, newIdx) => {
        slotList.appendChild(createNestedComponentItem(comp, newIdx, slotName));
      });
    }

    showToast('Component removed');
  }

  function duplicateNestedComponent(slotName, idx) {
    const slotContainer = document.querySelector(`.componentslot-container[data-field-key="${slotName}"]`);
    if (!slotContainer || !slotContainer._nestedComponents) return;

    const original = slotContainer._nestedComponents[idx];
    // Deep copy the component
    const copy = JSON.parse(JSON.stringify(original));
    // Generate new unique ID
    copy.id = 'nested-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

    // Generate new anchor_id if the component has one
    const compDef = componentsLib.find(c => c.id === copy.type);
    if (compDef && compDef.editable_fields.some(f => f.name === 'anchor_id')) {
      copy.data.anchor_id = generateComponentAnchorId(copy.type);
    }

    // Insert copy right after the original
    slotContainer._nestedComponents.splice(idx + 1, 0, copy);

    // Re-render the list
    const slotList = slotContainer.querySelector('.slot-component-list');
    slotList.innerHTML = '';
    slotContainer._nestedComponents.forEach((comp, newIdx) => {
      slotList.appendChild(createNestedComponentItem(comp, newIdx, slotName));
    });

    const compName = compDef ? compDef.name : copy.type;
    showToast(`Duplicated "${compName}"`);
  }

  async function uploadImageFile(file, inputElement, previewElement) {
    // Validate
    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
    if (!validTypes.includes(file.type)) {
      showToast('Invalid file type. Use JPG, PNG, GIF, WebP, or SVG.', 'danger');
      return;
    }

    try {
      const formData = new FormData();
      formData.append('file', file);

      const response = await fetch('/builder/assets/upload', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        inputElement.value = data.url;
        if (previewElement) {
          previewElement.src = data.url;
        }
        showToast('Image uploaded');
      } else {
        showToast('Upload failed: ' + data.error, 'danger');
      }
    } catch (error) {
      showToast('Upload error: ' + error.message, 'danger');
    }
  }

  async function savePage() {
    // Update page settings
    pageData.title = document.getElementById('pageTitle').value;
    pageData.meta_description = document.getElementById('metaDescription').value;

    try {
      const response = await fetch(`/builder/pages/${pageId}/save`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(pageData)
      });

      const data = await response.json();

      if (data.success) {
        // Clear unsaved changes flag
        hasUnsavedChanges = false;
        savedPageDataJSON = JSON.stringify(pageData);
        // Refresh preview to show published version
        refreshPreview();
        showToast('Page saved and published!', 'success');
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      alert('Error saving page: ' + error.message);
    }
  }

  async function refreshPreview() {
    const frame = document.getElementById('previewFrame');

    try {
      // POST current unsaved page data to get live preview
      const response = await fetch(`/builder/preview/${pageId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(pageData)
      });

      if (response.ok) {
        const html = await response.text();
        // Use srcdoc to display the preview without saving
        frame.srcdoc = html;
      } else {
        console.error('Preview failed:', response.status);
      }
    } catch (error) {
      console.error('Preview error:', error);
    }
  }

  // Rich Text Editor Helper Functions
  function rtExec(command, value = null) {
    document.execCommand(command, false, value);
    // Re-focus the editor
    const activeEditor = document.querySelector('.richtext-editor:focus');
    if (activeEditor) activeEditor.focus();
  }

  function rtPromptColor() {
    // Create a temporary color picker
    const colorInput = document.createElement('input');
    colorInput.type = 'color';
    colorInput.value = '#000000';
    colorInput.style.position = 'absolute';
    colorInput.style.opacity = '0';
    document.body.appendChild(colorInput);
    colorInput.addEventListener('input', (e) => {
      document.execCommand('foreColor', false, e.target.value);
    });
    colorInput.addEventListener('change', () => {
      colorInput.remove();
    });
    colorInput.click();
  }

  // Link suggestions cache and functions
  let linkSuggestionsCache = null;

  async function loadLinkSuggestions() {
    if (linkSuggestionsCache) return linkSuggestionsCache;
    try {
      const response = await fetch('/builder/link-suggestions');
      const data = await response.json();
      linkSuggestionsCache = data.suggestions || [];
      return linkSuggestionsCache;
    } catch (e) {
      console.error('Error loading suggestions:', e);
      return [];
    }
  }

  function rtPromptLink() {
    // Save current selection before opening modal
    saveSelection();

    // Create link modal if it doesn't exist
    if (!document.getElementById('linkInsertModal')) {
      const modalHtml = `
        <div class="modal fade" id="linkInsertModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-link-45deg"></i> Insert Link</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">URL</label>
                  <div class="position-relative">
                    <input type="text" class="form-control" id="linkUrlInput" placeholder="https:// or /page.html or #anchor">
                    <div id="linkSuggestionsDropdown" class="link-suggestions-dropdown"></div>
                  </div>
                  <small class="text-muted">Type to search pages and sections, or enter any URL</small>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="insertLinkFromModal()">Insert Link</button>
              </div>
            </div>
          </div>
        </div>
        <style>
          .link-suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1060;
            max-height: 200px;
            overflow-y: auto;
            display: none;
          }
          .link-suggestions-dropdown .suggestion-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
          }
          .link-suggestions-dropdown .suggestion-item:hover {
            background: #f8f9fa;
          }
          .link-suggestions-dropdown .suggestion-item small {
            margin-left: auto;
            color: #6c757d;
          }
        </style>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);

      // Setup suggestions for the input
      const input = document.getElementById('linkUrlInput');
      input.addEventListener('input', async function() {
        const query = this.value.toLowerCase();
        const suggestions = await loadLinkSuggestions();
        const filtered = suggestions.filter(s =>
          s.label.toLowerCase().includes(query) ||
          s.url.toLowerCase().includes(query)
        ).slice(0, 8);

        const dropdown = document.getElementById('linkSuggestionsDropdown');
        if (filtered.length === 0 || query.length < 1) {
          dropdown.style.display = 'none';
          return;
        }

        dropdown.innerHTML = filtered.map(s => `
          <div class="suggestion-item" data-url="${s.url}">
            <i class="bi bi-${s.type === 'page' ? 'file-earmark' : 'hash'}"></i>
            <span>${s.label}</span>
            <small>${s.url}</small>
          </div>
        `).join('');
        dropdown.style.display = 'block';

        // Add click handlers
        dropdown.querySelectorAll('.suggestion-item').forEach(item => {
          item.addEventListener('mousedown', function(e) {
            e.preventDefault();
            input.value = this.dataset.url;
            dropdown.style.display = 'none';
          });
        });
      });

      input.addEventListener('blur', function() {
        setTimeout(() => {
          document.getElementById('linkSuggestionsDropdown').style.display = 'none';
        }, 200);
      });

      // Allow Enter to submit
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          insertLinkFromModal();
        }
      });
    }

    // Reset and show modal
    document.getElementById('linkUrlInput').value = '';
    document.getElementById('linkSuggestionsDropdown').style.display = 'none';
    const linkModal = new bootstrap.Modal(document.getElementById('linkInsertModal'));
    linkModal.show();

    // Focus input after modal is shown
    document.getElementById('linkInsertModal').addEventListener('shown.bs.modal', function() {
      document.getElementById('linkUrlInput').focus();
    }, { once: true });
  }

  function insertLinkFromModal() {
    const url = document.getElementById('linkUrlInput').value.trim();
    if (!url) return;

    // Close modal
    const linkModal = bootstrap.Modal.getInstance(document.getElementById('linkInsertModal'));
    linkModal.hide();

    // Restore selection and insert link
    restoreSelection();
    document.execCommand('createLink', false, url);
  }

  function rtApplyFont(fontName) {
    document.execCommand('fontName', false, fontName);
  }

  function rtApplySize(size) {
    // Use CSS font-size via span since execCommand fontSize only supports 1-7
    const selection = window.getSelection();
    if (selection.rangeCount > 0 && !selection.isCollapsed) {
      const range = selection.getRangeAt(0);
      const span = document.createElement('span');
      span.style.fontSize = size;
      try {
        range.surroundContents(span);
      } catch(e) {
        // If range crosses element boundaries, use execCommand as fallback
        document.execCommand('fontSize', false, '7');
        // Then try to update the generated font tags
        const editor = document.querySelector('.richtext-editor');
        if (editor) {
          editor.querySelectorAll('font[size="7"]').forEach(font => {
            font.removeAttribute('size');
            font.style.fontSize = size;
          });
        }
      }
    }
  }

  // Store selection for emoji insertion
  let savedSelection = null;
  let lastActiveEditor = null;

  function saveSelection() {
    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
      savedSelection = selection.getRangeAt(0).cloneRange();
    }
  }

  function restoreSelection() {
    if (savedSelection) {
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(savedSelection);
    }
  }

  function rtInsertEmoji(btn) {
    // Save the current selection before showing popup
    lastActiveEditor = document.querySelector('.richtext-editor');
    if (lastActiveEditor) {
      lastActiveEditor.focus();
      saveSelection();
    }

    // Common emoji picker
    const emojis = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];

    // Create emoji popup
    let popup = document.getElementById('emojiPopup');
    if (popup) popup.remove();

    popup = document.createElement('div');
    popup.id = 'emojiPopup';
    popup.className = 'emoji-popup position-absolute bg-white border rounded shadow p-2';
    popup.style.zIndex = '1100';
    popup.innerHTML = emojis.map(e => `<span class="emoji-item" onclick="rtInsertEmojiChar('${e}')" style="cursor:pointer;font-size:1.5rem;padding:2px;">${e}</span>`).join('');

    const rect = btn.getBoundingClientRect();
    popup.style.top = (rect.bottom + window.scrollY + 5) + 'px';
    popup.style.left = rect.left + 'px';

    document.body.appendChild(popup);

    // Close on click outside
    setTimeout(() => {
      document.addEventListener('click', function closePopup(e) {
        if (!popup.contains(e.target) && e.target !== btn) {
          popup.remove();
          document.removeEventListener('click', closePopup);
        }
      });
    }, 100);
  }

  function rtInsertEmojiChar(emoji) {
    // Restore selection and insert emoji at cursor position
    if (lastActiveEditor) {
      lastActiveEditor.focus();
      restoreSelection();
      document.execCommand('insertHTML', false, emoji);
      // Update hidden input
      const container = lastActiveEditor.closest('.richtext-editor-container');
      if (container) {
        const hiddenInput = container.querySelector('input[type="hidden"]');
        if (hiddenInput) hiddenInput.value = lastActiveEditor.innerHTML;
      }
    }
    const popup = document.getElementById('emojiPopup');
    if (popup) popup.remove();
  }

  // Map Pin Editor Modal
  let currentPinData = null;
  let currentPinIndex = null;
  let currentPinRenderCallback = null;
  let currentPinImagesGrid = null;

  function openMapPinEditorModal(pinsArray, pinIndex, renderCallback) {
    currentPinData = pinsArray;
    currentPinIndex = pinIndex;
    currentPinRenderCallback = renderCallback;

    const pin = pinsArray[pinIndex];

    // Create modal if it doesn't exist
    if (!document.getElementById('mapPinEditorModal')) {
      const modalHtml = `
        <div class="modal fade" id="mapPinEditorModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-geo-alt"></i> Edit Pin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">Title</label>
                  <input type="text" class="form-control" id="pinEditorTitle">
                </div>
                <div class="mb-3">
                  <label class="form-label">Description</label>
                  <textarea class="form-control" id="pinEditorDescription" rows="3"></textarea>
                </div>
                <div class="row mb-3">
                  <div class="col-6">
                    <label class="form-label">Latitude</label>
                    <input type="text" class="form-control" id="pinEditorLat" readonly>
                  </div>
                  <div class="col-6">
                    <label class="form-label">Longitude</label>
                    <input type="text" class="form-control" id="pinEditorLng" readonly>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Images</label>
                  <div id="pinEditorImagesGrid" class="row row-cols-4 g-2 mb-2"></div>
                  <button type="button" class="btn btn-outline-primary btn-sm" onclick="openPinImageBrowser()">
                    <i class="bi bi-plus-circle"></i> Add Images
                  </button>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePinEdits()">Save Pin</button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    // Populate fields
    document.getElementById('pinEditorTitle').value = pin.title || '';
    document.getElementById('pinEditorDescription').value = pin.description || '';
    document.getElementById('pinEditorLat').value = pin.lat || '';
    document.getElementById('pinEditorLng').value = pin.lng || '';

    // Populate images grid
    currentPinImagesGrid = document.getElementById('pinEditorImagesGrid');
    renderPinImages(pin.images || []);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('mapPinEditorModal'));
    modal.show();
  }

  function renderPinImages(images) {
    currentPinImagesGrid.innerHTML = '';

    images.forEach((imgUrl, idx) => {
      const col = document.createElement('div');
      col.className = 'col';
      col.dataset.imageIndex = idx;

      const thumb = document.createElement('div');
      thumb.className = 'pin-image-thumb position-relative';
      thumb.style.cssText = 'aspect-ratio:1;border-radius:4px;overflow:hidden;border:1px solid #dee2e6;';

      const img = document.createElement('img');
      img.src = imgUrl;
      img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
      thumb.appendChild(img);

      // Delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'btn btn-danger btn-sm position-absolute';
      deleteBtn.style.cssText = 'top:2px;right:2px;padding:0.1rem 0.3rem;font-size:0.7rem;';
      deleteBtn.innerHTML = '<i class="bi bi-x"></i>';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        removePinImage(idx);
      };
      thumb.appendChild(deleteBtn);

      col.appendChild(thumb);
      currentPinImagesGrid.appendChild(col);
    });
  }

  function removePinImage(idx) {
    const pin = currentPinData[currentPinIndex];
    if (pin.images) {
      pin.images.splice(idx, 1);
      renderPinImages(pin.images);
    }
  }

  function openPinImageBrowser() {
    // Use the existing image browser in multi-select mode
    const pin = currentPinData[currentPinIndex];
    if (!pin.images) pin.images = [];

    // Create a temporary container for the image browser
    const tempGrid = {
      querySelectorAll: () => [],
      appendChild: (item) => {
        // When image browser adds items, extract URL and add to pin
        const url = item.querySelector('img')?.src;
        if (url) {
          pin.images.push(url);
          renderPinImages(pin.images);
        }
      }
    };

    const tempContainer = {
      dataset: { fieldKey: 'pin_images' }
    };

    // Store originals
    const origGrid = currentImageListGrid;
    const origContainer = currentImageListContainer;

    currentImageListGrid = tempGrid;
    currentImageListContainer = tempContainer;
    pendingImageSelections = [];

    imageBrowserModal._isListMode = true;
    imageBrowserModal._isPinMode = true;

    document.getElementById('imageListModeHint').style.display = 'inline';
    document.getElementById('imageBrowserCancelBtn').querySelector('#imageBrowserCancelText').textContent = 'Cancel';
    document.getElementById('imageBrowserDoneBtn').style.display = 'inline-block';
    updateSelectionCount();

    loadImageGrid();
    imageBrowserModal.show();

    // Override submit for pin mode
    const modal = document.getElementById('imageBrowserModal');
    const handler = () => {
      if (imageBrowserModal._isPinMode && pendingImageSelections.length > 0) {
        pendingImageSelections.forEach(url => {
          pin.images.push(url);
        });
        renderPinImages(pin.images);
        showToast(`Added ${pendingImageSelections.length} image${pendingImageSelections.length > 1 ? 's' : ''}`);
      }
      imageBrowserModal._isPinMode = false;
      currentImageListGrid = origGrid;
      currentImageListContainer = origContainer;
      modal.removeEventListener('hidden.bs.modal', handler);
    };
    modal.addEventListener('hidden.bs.modal', handler);
  }

  function savePinEdits() {
    const pin = currentPinData[currentPinIndex];
    pin.title = document.getElementById('pinEditorTitle').value;
    pin.description = document.getElementById('pinEditorDescription').value;

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('mapPinEditorModal'));
    modal.hide();

    // Re-render pins
    if (currentPinRenderCallback) {
      currentPinRenderCallback();
    }
  }
</script>
{% endblock %}
