{% extends "base.html" %}

{% block title %}{{ site.site_name }} - Site Builder{% endblock %}

{% block content %}
<div class="row">
  <!-- Sidebar -->
  <div class="col-md-3">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-files"></i> Pages</span>
        <button class="btn btn-sm btn-outline-primary" onclick="showNewPageModal()">
          <i class="bi bi-plus"></i>
        </button>
      </div>
      <div class="list-group list-group-flush">
        {% for page in pages %}
        <div class="list-group-item d-flex justify-content-between align-items-center">
          <a href="{{ url_for('builder_edit_page', page_id=page.id) }}" class="text-decoration-none flex-grow-1">
            <i class="bi bi-file-earmark-text"></i> {{ page.title }}
            {% if page.id == 'index' %}
            <span class="badge bg-secondary ms-1">Home</span>
            {% endif %}
          </a>
          <button class="btn btn-sm btn-outline-secondary" onclick="copyPage('{{ page.id }}', '{{ page.title }}')" title="Copy page">
            <i class="bi bi-copy"></i>
          </button>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card mb-4">
      <div class="card-header">
        <i class="bi bi-lightning"></i> Quick Actions
      </div>
      <div class="list-group list-group-flush">
        <a href="https://{{ domain }}" target="_blank" class="list-group-item list-group-item-action">
          <i class="bi bi-box-arrow-up-right"></i> View Live Site
        </a>
        <button class="list-group-item list-group-item-action" onclick="publishAll()">
          <i class="bi bi-cloud-upload"></i> Publish All Pages
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="col-md-9">
    <!-- Site Settings Card -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-gear"></i> Site Settings</span>
        <button class="btn btn-sm btn-primary" onclick="saveSettings()">
          <i class="bi bi-check"></i> Save Changes
        </button>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Site Name</label>
              <input type="text" class="form-control" id="siteName" value="{{ site.site_name }}">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Color Scheme</label>
              <select class="form-select" id="colorScheme" onchange="onColorSchemeChange()">
                {% for scheme in color_schemes %}
                <option value="{{ scheme.id }}" {% if scheme.id == site.color_scheme_id %}selected{% endif %}>
                  {{ scheme.name }}
                </option>
                {% endfor %}
                <option value="custom" {% if site.color_scheme_id == 'custom' %}selected{% endif %}>Custom</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Logo</label>
              <div class="input-group">
                <input type="text" class="form-control" id="logoUrl" value="{{ site.logo_url }}" placeholder="Upload or paste URL">
                <input type="file" id="logoUpload" accept="image/*" style="display: none;" onchange="uploadLogo(this)">
                <button class="btn btn-outline-secondary" onclick="document.getElementById('logoUpload').click()">
                  <i class="bi bi-upload"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Color Preview (shows current scheme colors) -->
        <div class="mt-3" id="colorPreviewSection">
          <label class="form-label small text-muted">Current Color Palette:</label>
          <div class="d-flex flex-wrap gap-1" id="colorPreviewStrip">
            <!-- Populated by JavaScript -->
          </div>
        </div>

        <!-- Custom Colors (shown only when "Custom" is selected) -->
        <div class="mt-4" id="customColorsSection" style="display: none;">
          <h6>Custom Colors</h6>
          <p class="text-muted small">Set your own colors for your site.</p>
          <div class="row row-cols-2 row-cols-md-4 g-2">
            <div class="col">
              <label class="form-label small">Primary</label>
              <input type="color" class="form-control form-control-color" id="colorPrimary"
                     value="{{ site.color_overrides.primary or '#0066cc' }}">
            </div>
            <div class="col">
              <label class="form-label small">Secondary</label>
              <input type="color" class="form-control form-control-color" id="colorSecondary"
                     value="{{ site.color_overrides.secondary or '#004499' }}">
            </div>
            <div class="col">
              <label class="form-label small">Accent</label>
              <input type="color" class="form-control form-control-color" id="colorAccent"
                     value="{{ site.color_overrides.accent or '#00ccff' }}">
            </div>
            <div class="col">
              <label class="form-label small">Background</label>
              <input type="color" class="form-control form-control-color" id="colorBackground"
                     value="{{ site.color_overrides.background or '#f8fafc' }}">
            </div>
            <div class="col">
              <label class="form-label small">Surface</label>
              <input type="color" class="form-control form-control-color" id="colorSurface"
                     value="{{ site.color_overrides.surface or '#ffffff' }}">
            </div>
            <div class="col">
              <label class="form-label small">Text</label>
              <input type="color" class="form-control form-control-color" id="colorText"
                     value="{{ site.color_overrides.text or '#1a1a2e' }}">
            </div>
            <div class="col">
              <label class="form-label small">Muted Text</label>
              <input type="color" class="form-control form-control-color" id="colorTextMuted"
                     value="{{ site.color_overrides['text-muted'] or '#6b7280' }}">
            </div>
            <div class="col">
              <label class="form-label small">Border</label>
              <input type="color" class="form-control form-control-color" id="colorBorder"
                     value="{{ site.color_overrides.border or '#e5e7eb' }}">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Links -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-list"></i> Main Navigation</span>
        <button class="btn btn-sm btn-outline-primary" onclick="addNavLink()">
          <i class="bi bi-plus"></i> Add Link
        </button>
      </div>
      <div class="card-body">
        <p class="text-muted small mb-3">Configure the navigation links shown in the header. These links appear on all pages.</p>
        <div id="navLinksContainer">
          {% for nav_item in site.navigation %}
          <div class="nav-link-item d-flex align-items-center gap-2 mb-2" data-index="{{ loop.index0 }}">
            <i class="bi bi-grip-vertical text-muted" style="cursor: grab;"></i>
            <input type="text" class="form-control form-control-sm" placeholder="Label" value="{{ nav_item.label }}" style="width: 120px;" onchange="updateNavLinks()">
            <input type="text" class="form-control form-control-sm flex-grow-1" placeholder="URL (e.g., /about.html)" value="{{ nav_item.url }}" onchange="updateNavLinks()">
            <button class="btn btn-sm btn-outline-danger" onclick="removeNavLink(this)" title="Remove link">
              <i class="bi bi-trash"></i>
            </button>
          </div>
          {% endfor %}
        </div>
        <div class="mt-3 d-flex justify-content-end">
          <button class="btn btn-primary btn-sm" onclick="saveNavLinks()">
            <i class="bi bi-check"></i> Save Navigation
          </button>
        </div>
      </div>
    </div>

    <!-- Footer Settings -->
    <div class="card mb-4">
      <div class="card-header">
        <i class="bi bi-window-dock"></i> Footer
      </div>
      <div class="card-body">
        <p class="text-muted small mb-3">Configure the footer that appears on all pages.</p>
        <div class="mb-3">
          <label class="form-label small">Footer Text</label>
          <input type="text" class="form-control form-control-sm" id="footerText" value="{{ site.footer_text }}" placeholder="Â© 2025 Your Company. All rights reserved.">
        </div>

        <hr>
        <h6 class="mb-3"><i class="bi bi-share"></i> Social Links</h6>
        <p class="text-muted small mb-2">Add links to your social media profiles. Leave empty to hide.</p>

        <div class="row g-2 mb-2">
          <div class="col-6">
            <label class="form-label small"><i class="bi bi-facebook"></i> Facebook</label>
            <input type="url" class="form-control form-control-sm" id="socialFacebook"
                   value="{{ site.social_links.facebook if site.social_links else '' }}"
                   placeholder="https://facebook.com/yourpage">
          </div>
          <div class="col-6">
            <label class="form-label small"><i class="bi bi-instagram"></i> Instagram</label>
            <input type="url" class="form-control form-control-sm" id="socialInstagram"
                   value="{{ site.social_links.instagram if site.social_links else '' }}"
                   placeholder="https://instagram.com/yourpage">
          </div>
        </div>
        <div class="row g-2 mb-2">
          <div class="col-6">
            <label class="form-label small"><i class="bi bi-twitter-x"></i> X (Twitter)</label>
            <input type="url" class="form-control form-control-sm" id="socialTwitter"
                   value="{{ site.social_links.twitter if site.social_links else '' }}"
                   placeholder="https://x.com/yourhandle">
          </div>
          <div class="col-6">
            <label class="form-label small"><i class="bi bi-linkedin"></i> LinkedIn</label>
            <input type="url" class="form-control form-control-sm" id="socialLinkedin"
                   value="{{ site.social_links.linkedin if site.social_links else '' }}"
                   placeholder="https://linkedin.com/in/yourprofile">
          </div>
        </div>
        <div class="row g-2 mb-3">
          <div class="col-6">
            <label class="form-label small"><i class="bi bi-youtube"></i> YouTube</label>
            <input type="url" class="form-control form-control-sm" id="socialYoutube"
                   value="{{ site.social_links.youtube if site.social_links else '' }}"
                   placeholder="https://youtube.com/@yourchannel">
          </div>
          <div class="col-6">
            <label class="form-label small"><i class="bi bi-envelope"></i> Email</label>
            <input type="email" class="form-control form-control-sm" id="socialEmail"
                   value="{{ site.social_links.email if site.social_links else '' }}"
                   placeholder="contact@yoursite.com">
          </div>
        </div>

        <div class="d-flex justify-content-end">
          <button class="btn btn-primary btn-sm" onclick="saveFooterSettings()">
            <i class="bi bi-check"></i> Save Footer
          </button>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-layout-sidebar"></i> Sidebar</span>
        <button class="btn btn-sm btn-outline-primary" onclick="addSidebarWidget()">
          <i class="bi bi-plus"></i> Add Widget
        </button>
      </div>
      <div class="card-body">
        <p class="text-muted small mb-3">Configure the sidebar that appears on all pages. The sidebar is collapsible and appears on the left side of the page.</p>
        <div id="sidebarWidgetsContainer">
          {% for widget in site.sidebar %}
          <div class="sidebar-widget-item border rounded p-3 mb-2" data-index="{{ loop.index0 }}" data-type="{{ widget.type }}">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <strong>{{ widget.type | replace('-', ' ') | title }}</strong>
              <div>
                <button class="btn btn-sm btn-outline-primary" onclick="editSidebarWidget({{ loop.index0 }})" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="removeSidebarWidget({{ loop.index0 }})" title="Remove">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
            {% if widget.data.title %}
            <small class="text-muted">{{ widget.data.title }}</small>
            {% endif %}
          </div>
          {% else %}
          <div id="noSidebarWidgets" class="text-center text-muted py-3">
            <i class="bi bi-layout-sidebar"></i>
            <p class="mb-0">No sidebar widgets yet. Click "Add Widget" to get started.</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Preview -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-eye"></i> Site Preview</span>
        <div class="btn-group btn-group-sm">
          <button class="btn btn-outline-secondary active" onclick="setPreviewSize('desktop')">
            <i class="bi bi-display"></i>
          </button>
          <button class="btn btn-outline-secondary" onclick="setPreviewSize('tablet')">
            <i class="bi bi-tablet"></i>
          </button>
          <button class="btn btn-outline-secondary" onclick="setPreviewSize('mobile')">
            <i class="bi bi-phone"></i>
          </button>
        </div>
      </div>
      <div class="card-body p-0">
        <div id="previewContainer" style="background: #f0f0f0; padding: 1rem; overflow-x: auto;">
          <iframe id="previewFrame" src="{{ url_for('builder_preview', page_id='index') }}"
                  style="width: 100%; height: 500px; border: none; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
          </iframe>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Page Modal -->
<div class="modal fade" id="newPageModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Page</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Page Title</label>
          <input type="text" class="form-control" id="newPageTitle" placeholder="About Us">
        </div>
        <div class="mb-3">
          <label class="form-label">Page URL</label>
          <div class="input-group">
            <span class="input-group-text">{{ domain }}/</span>
            <input type="text" class="form-control" id="newPageSlug" placeholder="about">
            <span class="input-group-text">.html</span>
          </div>
          <div class="form-text">Leave blank to auto-generate from title.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="createPage()">Create Page</button>
      </div>
    </div>
  </div>
</div>

<!-- Sidebar Widget Modal -->
<div class="modal fade" id="sidebarWidgetModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sidebarWidgetModalTitle">Add Sidebar Widget</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="widgetTypeSelector" class="mb-3">
          <label class="form-label">Widget Type</label>
          <select class="form-select" id="widgetType" onchange="showWidgetFields()">
            <!-- Populated by JavaScript -->
          </select>
        </div>
        <div id="widgetFields">
          <!-- Dynamic fields populated by JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveSidebarWidget()">Save Widget</button>
      </div>
    </div>
  </div>
</div>

<script>
  let newPageModal;
  let sidebarWidgetModal;
  let sidebarWidgets = {{ site.sidebar | tojson | safe if site.sidebar else '[]' }};
  let editingSidebarIndex = -1;
  const colorSchemes = {{ color_schemes | tojson | safe }};
  // Allow sidebar and content components in the sidebar (exclude navigation, footer, and slot-based components)
  const allComponents = {{ components | tojson | safe }};
  const sidebarComponentDefs = allComponents.filter(c =>
    c.category !== 'navigation' &&
    c.category !== 'footer' &&
    !c.has_slots
  );

  document.addEventListener('DOMContentLoaded', function() {
    newPageModal = new bootstrap.Modal(document.getElementById('newPageModal'));
    sidebarWidgetModal = new bootstrap.Modal(document.getElementById('sidebarWidgetModal'));

    // Auto-generate slug from title
    document.getElementById('newPageTitle').addEventListener('input', function() {
      const slug = this.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
      document.getElementById('newPageSlug').value = slug;
    });

    // Populate widget type dropdown
    const widgetTypeSelect = document.getElementById('widgetType');
    sidebarComponentDefs.forEach(comp => {
      const option = document.createElement('option');
      option.value = comp.id;
      option.textContent = comp.name;
      widgetTypeSelect.appendChild(option);
    });

    // Initialize custom colors visibility
    onColorSchemeChange();
  });

  function onColorSchemeChange() {
    const schemeId = document.getElementById('colorScheme').value;
    const customSection = document.getElementById('customColorsSection');
    const previewStrip = document.getElementById('colorPreviewStrip');

    if (schemeId === 'custom') {
      customSection.style.display = 'block';
      // Show custom colors in preview
      updateColorPreview({
        primary: document.getElementById('colorPrimary').value,
        secondary: document.getElementById('colorSecondary').value,
        accent: document.getElementById('colorAccent').value,
        background: document.getElementById('colorBackground').value,
        surface: document.getElementById('colorSurface').value,
        text: document.getElementById('colorText').value,
        'text-muted': document.getElementById('colorTextMuted').value,
        border: document.getElementById('colorBorder').value
      });
    } else {
      customSection.style.display = 'none';
      // Pre-populate custom colors with selected scheme's colors
      const scheme = colorSchemes.find(s => s.id === schemeId);
      if (scheme && scheme.colors) {
        document.getElementById('colorPrimary').value = scheme.colors.primary || '#0066cc';
        document.getElementById('colorSecondary').value = scheme.colors.secondary || '#004499';
        document.getElementById('colorAccent').value = scheme.colors.accent || '#00ccff';
        document.getElementById('colorBackground').value = scheme.colors.background || '#f8fafc';
        document.getElementById('colorSurface').value = scheme.colors.surface || '#ffffff';
        document.getElementById('colorText').value = scheme.colors.text || '#1a1a2e';
        document.getElementById('colorTextMuted').value = scheme.colors['text-muted'] || '#6b7280';
        document.getElementById('colorBorder').value = scheme.colors.border || '#e5e7eb';
        updateColorPreview(scheme.colors);
      }
    }
  }

  function updateColorPreview(colors) {
    const strip = document.getElementById('colorPreviewStrip');
    const colorLabels = {
      'primary': 'Primary',
      'secondary': 'Secondary',
      'accent': 'Accent',
      'background': 'Background',
      'surface': 'Surface',
      'text': 'Text',
      'text-muted': 'Muted',
      'border': 'Border'
    };
    strip.innerHTML = '';
    for (const [key, label] of Object.entries(colorLabels)) {
      if (colors[key]) {
        const swatch = document.createElement('div');
        swatch.className = 'd-flex flex-column align-items-center';
        swatch.innerHTML = `
          <div style="width: 32px; height: 32px; border-radius: 4px; background-color: ${colors[key]}; border: 1px solid #ddd;" title="${label}: ${colors[key]}"></div>
          <small class="text-muted" style="font-size: 0.65rem;">${label}</small>
        `;
        strip.appendChild(swatch);
      }
    }
  }

  function showNewPageModal() {
    document.getElementById('newPageTitle').value = '';
    document.getElementById('newPageSlug').value = '';
    newPageModal.show();
  }

  async function createPage() {
    const title = document.getElementById('newPageTitle').value.trim();
    const slug = document.getElementById('newPageSlug').value.trim();

    if (!title) {
      alert('Please enter a page title');
      return;
    }

    try {
      const response = await fetch('/builder/pages/new', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, page_id: slug || undefined })
      });

      const data = await response.json();

      if (data.success) {
        window.location.href = '/builder/pages/' + data.page.id;
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      alert('Error creating page: ' + error.message);
    }
  }

  async function saveSettings() {
    const schemeId = document.getElementById('colorScheme').value;
    const colorOverrides = {};

    // Only save custom colors if "Custom" scheme is selected
    if (schemeId === 'custom') {
      colorOverrides.primary = document.getElementById('colorPrimary').value;
      colorOverrides.secondary = document.getElementById('colorSecondary').value;
      colorOverrides.accent = document.getElementById('colorAccent').value;
      colorOverrides.background = document.getElementById('colorBackground').value;
      colorOverrides.surface = document.getElementById('colorSurface').value;
      colorOverrides.text = document.getElementById('colorText').value;
      colorOverrides['text-muted'] = document.getElementById('colorTextMuted').value;
      colorOverrides.border = document.getElementById('colorBorder').value;
    }

    try {
      const response = await fetch('/builder/site/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          site_name: document.getElementById('siteName').value,
          color_scheme_id: schemeId,
          logo_url: document.getElementById('logoUrl').value,
          color_overrides: colorOverrides
        })
      });

      const data = await response.json();

      if (data.success) {
        // Republish to apply changes
        await publishAll();
        document.getElementById('previewFrame').src = document.getElementById('previewFrame').src;
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      alert('Error saving settings: ' + error.message);
    }
  }

  async function publishAll() {
    try {
      const response = await fetch('/builder/publish', { method: 'POST' });
      const data = await response.json();

      if (data.success) {
        // Refresh preview
        document.getElementById('previewFrame').src = document.getElementById('previewFrame').src;
      } else {
        alert('Error publishing: ' + data.error);
      }
    } catch (error) {
      alert('Error publishing: ' + error.message);
    }
  }

  async function uploadLogo(input) {
    if (!input.files || !input.files[0]) return;

    const formData = new FormData();
    formData.append('file', input.files[0]);

    try {
      const response = await fetch('/builder/assets/upload', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        document.getElementById('logoUrl').value = data.url;
      } else {
        alert('Error uploading: ' + data.error);
      }
    } catch (error) {
      alert('Error uploading: ' + error.message);
    }
  }

  function setPreviewSize(size) {
    const frame = document.getElementById('previewFrame');
    const container = document.getElementById('previewContainer');

    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.closest('.btn').classList.add('active');

    switch(size) {
      case 'mobile':
        frame.style.width = '375px';
        frame.style.margin = '0 auto';
        frame.style.display = 'block';
        break;
      case 'tablet':
        frame.style.width = '768px';
        frame.style.margin = '0 auto';
        frame.style.display = 'block';
        break;
      default:
        frame.style.width = '100%';
        frame.style.margin = '0';
    }
  }

  // Navigation management
  function addNavLink() {
    const container = document.getElementById('navLinksContainer');
    const index = container.children.length;
    const html = `
      <div class="nav-link-item d-flex align-items-center gap-2 mb-2" data-index="${index}">
        <i class="bi bi-grip-vertical text-muted" style="cursor: grab;"></i>
        <input type="text" class="form-control form-control-sm" placeholder="Label" style="width: 120px;" onchange="updateNavLinks()">
        <input type="text" class="form-control form-control-sm flex-grow-1" placeholder="URL (e.g., /about.html)" onchange="updateNavLinks()">
        <button class="btn btn-sm btn-outline-danger" onclick="removeNavLink(this)" title="Remove link">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
  }

  function removeNavLink(button) {
    button.closest('.nav-link-item').remove();
    // Re-index items
    const items = document.querySelectorAll('.nav-link-item');
    items.forEach((item, idx) => item.dataset.index = idx);
  }

  function getNavLinksData() {
    const items = document.querySelectorAll('.nav-link-item');
    const links = [];
    items.forEach(item => {
      const inputs = item.querySelectorAll('input');
      const label = inputs[0].value.trim();
      const url = inputs[1].value.trim();
      if (label && url) {
        links.push({ label, url, children: [] });
      }
    });
    return links;
  }

  async function saveNavLinks() {
    const navigation = getNavLinksData();

    try {
      const response = await fetch('/builder/site/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ navigation })
      });

      const data = await response.json();

      if (data.success) {
        // Republish to apply changes
        await publishAll();
        alert('Navigation saved successfully!');
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      alert('Error saving navigation: ' + error.message);
    }
  }

  // Sidebar widget management
  function addSidebarWidget() {
    editingSidebarIndex = -1;
    document.getElementById('sidebarWidgetModalTitle').textContent = 'Add Sidebar Widget';
    document.getElementById('widgetTypeSelector').style.display = 'block';
    document.getElementById('widgetType').value = 'sidebar-about';
    showWidgetFields();
    sidebarWidgetModal.show();
  }

  function editSidebarWidget(index) {
    editingSidebarIndex = index;
    const widget = sidebarWidgets[index];
    document.getElementById('sidebarWidgetModalTitle').textContent = 'Edit Widget';
    document.getElementById('widgetTypeSelector').style.display = 'none';
    document.getElementById('widgetType').value = widget.type;
    showWidgetFields(widget.data);
    sidebarWidgetModal.show();
  }

  function showWidgetFields(existingData = null) {
    const widgetType = document.getElementById('widgetType').value;
    const compDef = sidebarComponentDefs.find(c => c.id === widgetType);
    const container = document.getElementById('widgetFields');

    if (!compDef) {
      container.innerHTML = '<p class="text-muted">Widget type not found</p>';
      return;
    }

    container.innerHTML = '';

    compDef.editable_fields.forEach(field => {
      const value = existingData ? (existingData[field.name] !== undefined ? existingData[field.name] : field.default) : (field.default !== undefined ? field.default : '');
      const div = document.createElement('div');
      div.className = 'mb-3';

      const label = document.createElement('label');
      label.className = 'form-label';
      label.textContent = field.label;

      let input;
      switch (field.type) {
        case 'textarea':
          div.appendChild(label);
          input = document.createElement('textarea');
          input.className = 'form-control';
          input.rows = 3;
          input.value = value || '';
          input.dataset.fieldName = field.name;
          div.appendChild(input);
          break;

        case 'checkbox':
          div.className = 'mb-3 form-check';
          input = document.createElement('input');
          input.type = 'checkbox';
          input.className = 'form-check-input';
          input.checked = value === true || value === 'true';
          input.dataset.fieldName = field.name;
          input.id = 'widget_' + field.name;
          label.className = 'form-check-label';
          label.htmlFor = input.id;
          div.appendChild(input);
          div.appendChild(label);
          break;

        case 'select':
          div.appendChild(label);
          input = document.createElement('select');
          input.className = 'form-select';
          (field.options || []).forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            option.textContent = opt;
            option.selected = opt === value;
            input.appendChild(option);
          });
          input.dataset.fieldName = field.name;
          div.appendChild(input);
          break;

        case 'image':
          div.appendChild(label);
          const imgGroup = document.createElement('div');
          imgGroup.className = 'input-group';
          input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          input.value = value || '';
          input.placeholder = 'Image URL';
          input.dataset.fieldName = field.name;
          const uploadBtn = document.createElement('button');
          uploadBtn.type = 'button';
          uploadBtn.className = 'btn btn-outline-secondary';
          uploadBtn.innerHTML = '<i class="bi bi-upload"></i>';
          uploadBtn.onclick = () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.onchange = async (e) => {
              if (e.target.files[0]) {
                const formData = new FormData();
                formData.append('file', e.target.files[0]);
                try {
                  const response = await fetch('/builder/assets/upload', { method: 'POST', body: formData });
                  const data = await response.json();
                  if (data.success) input.value = data.url;
                } catch (err) { alert('Upload error: ' + err.message); }
              }
            };
            fileInput.click();
          };
          imgGroup.appendChild(input);
          imgGroup.appendChild(uploadBtn);
          div.appendChild(imgGroup);
          break;

        case 'imagelist':
          div.appendChild(label);
          const listContainer = document.createElement('div');
          listContainer.className = 'imagelist-sidebar-container border rounded p-2';
          listContainer.dataset.fieldName = field.name;
          const imageList = Array.isArray(value) ? value : [];
          const listPreview = document.createElement('div');
          listPreview.className = 'd-flex flex-wrap gap-1 mb-2';
          imageList.forEach((url, idx) => {
            const thumb = document.createElement('div');
            thumb.className = 'position-relative';
            thumb.style.cssText = 'width: 50px; height: 50px;';
            thumb.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:cover;border-radius:4px;">
              <button type="button" class="btn btn-sm btn-danger position-absolute" style="top:-5px;right:-5px;padding:0 4px;font-size:10px;" onclick="this.parentElement.remove()">&times;</button>`;
            thumb.dataset.imageUrl = url;
            listPreview.appendChild(thumb);
          });
          listContainer.appendChild(listPreview);
          const addImgBtn = document.createElement('button');
          addImgBtn.type = 'button';
          addImgBtn.className = 'btn btn-sm btn-outline-primary';
          addImgBtn.innerHTML = '<i class="bi bi-plus"></i> Add Image';
          addImgBtn.onclick = () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.onchange = async (e) => {
              if (e.target.files[0]) {
                const formData = new FormData();
                formData.append('file', e.target.files[0]);
                try {
                  const response = await fetch('/builder/assets/upload', { method: 'POST', body: formData });
                  const data = await response.json();
                  if (data.success) {
                    const thumb = document.createElement('div');
                    thumb.className = 'position-relative';
                    thumb.style.cssText = 'width: 50px; height: 50px;';
                    thumb.innerHTML = `<img src="${data.url}" style="width:100%;height:100%;object-fit:cover;border-radius:4px;">
                      <button type="button" class="btn btn-sm btn-danger position-absolute" style="top:-5px;right:-5px;padding:0 4px;font-size:10px;" onclick="this.parentElement.remove()">&times;</button>`;
                    thumb.dataset.imageUrl = data.url;
                    listPreview.appendChild(thumb);
                  }
                } catch (err) { alert('Upload error: ' + err.message); }
              }
            };
            fileInput.click();
          };
          listContainer.appendChild(addImgBtn);
          div.appendChild(listContainer);
          break;

        case 'range':
          div.appendChild(label);
          const rangeWrapper = document.createElement('div');
          rangeWrapper.className = 'd-flex align-items-center gap-2';
          const rangeInput = document.createElement('input');
          rangeInput.type = 'range';
          rangeInput.className = 'form-range flex-grow-1';
          rangeInput.min = field.min || 0;
          rangeInput.max = field.max || 100;
          rangeInput.value = value !== undefined && value !== '' ? value : (field.default || 50);
          rangeInput.dataset.fieldName = field.name;
          const rangeLabel = document.createElement('span');
          rangeLabel.className = 'badge bg-secondary';
          rangeLabel.style.minWidth = '40px';
          rangeLabel.textContent = rangeInput.value + '%';
          rangeInput.addEventListener('input', () => { rangeLabel.textContent = rangeInput.value + '%'; });
          rangeWrapper.appendChild(rangeInput);
          rangeWrapper.appendChild(rangeLabel);
          div.appendChild(rangeWrapper);
          break;

        case 'datetime':
          div.appendChild(label);
          const dtInput = document.createElement('input');
          dtInput.type = 'datetime-local';
          dtInput.className = 'form-control';
          dtInput.dataset.fieldName = field.name;
          if (value) dtInput.value = value.substring(0, 16);
          div.appendChild(dtInput);
          break;

        case 'richtext':
          div.appendChild(label);
          const rtTextarea = document.createElement('textarea');
          rtTextarea.className = 'form-control';
          rtTextarea.rows = 4;
          rtTextarea.value = value || '';
          rtTextarea.dataset.fieldName = field.name;
          const rtHelp = document.createElement('small');
          rtHelp.className = 'text-muted';
          rtHelp.textContent = 'HTML formatting supported';
          div.appendChild(rtTextarea);
          div.appendChild(rtHelp);
          break;

        case 'color':
          div.appendChild(label);
          const colorInput = document.createElement('input');
          colorInput.type = 'color';
          colorInput.className = 'form-control form-control-color';
          colorInput.value = value || '#000000';
          colorInput.dataset.fieldName = field.name;
          div.appendChild(colorInput);
          break;

        default:
          div.appendChild(label);
          input = document.createElement('input');
          input.type = field.type === 'email' ? 'email' : field.type === 'url' ? 'url' : 'text';
          input.className = 'form-control';
          input.value = value || '';
          if (field.placeholder) input.placeholder = field.placeholder;
          input.dataset.fieldName = field.name;
          div.appendChild(input);
      }

      container.appendChild(div);
    });
  }

  async function saveSidebarWidget() {
    const widgetType = document.getElementById('widgetType').value;
    const compDef = sidebarComponentDefs.find(c => c.id === widgetType);

    const data = {};
    // Regular inputs and selects
    document.querySelectorAll('#widgetFields input[data-field-name]:not([type="checkbox"]), #widgetFields select[data-field-name], #widgetFields textarea[data-field-name]').forEach(input => {
      data[input.dataset.fieldName] = input.value;
    });
    // Checkboxes
    document.querySelectorAll('#widgetFields input[type="checkbox"][data-field-name]').forEach(input => {
      data[input.dataset.fieldName] = input.checked;
    });
    // Image lists
    document.querySelectorAll('#widgetFields .imagelist-sidebar-container').forEach(container => {
      const images = [];
      container.querySelectorAll('[data-image-url]').forEach(thumb => {
        images.push(thumb.dataset.imageUrl);
      });
      data[container.dataset.fieldName] = images;
    });

    if (editingSidebarIndex >= 0) {
      // Update existing
      sidebarWidgets[editingSidebarIndex].data = data;
    } else {
      // Add new
      sidebarWidgets.push({
        id: 'sidebar-' + Date.now(),
        type: widgetType,
        data: data
      });
    }

    // Save to server
    try {
      const response = await fetch('/builder/site/sidebar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sidebar: sidebarWidgets })
      });

      const result = await response.json();
      if (result.success) {
        sidebarWidgetModal.hide();
        location.reload();
      } else {
        alert('Error saving sidebar: ' + result.error);
      }
    } catch (error) {
      alert('Error saving sidebar: ' + error.message);
    }
  }

  async function removeSidebarWidget(index) {
    if (!confirm('Remove this widget?')) return;

    sidebarWidgets.splice(index, 1);

    try {
      const response = await fetch('/builder/site/sidebar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sidebar: sidebarWidgets })
      });

      const result = await response.json();
      if (result.success) {
        location.reload();
      } else {
        alert('Error removing widget: ' + result.error);
      }
    } catch (error) {
      alert('Error removing widget: ' + error.message);
    }
  }

  // Page copy
  async function copyPage(pageId, pageTitle) {
    const newTitle = prompt(`Enter name for the copy of "${pageTitle}":`, `${pageTitle} (Copy)`);
    if (!newTitle) return;

    try {
      const response = await fetch(`/builder/pages/${pageId}/copy`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: newTitle })
      });

      const data = await response.json();

      if (data.success) {
        window.location.reload();
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      alert('Error copying page: ' + error.message);
    }
  }

  // Footer management
  async function saveFooterSettings() {
    const footerText = document.getElementById('footerText').value;

    // Collect social links (only include non-empty ones)
    const socialLinks = {};
    const facebook = document.getElementById('socialFacebook').value.trim();
    const instagram = document.getElementById('socialInstagram').value.trim();
    const twitter = document.getElementById('socialTwitter').value.trim();
    const linkedin = document.getElementById('socialLinkedin').value.trim();
    const youtube = document.getElementById('socialYoutube').value.trim();
    const email = document.getElementById('socialEmail').value.trim();

    if (facebook) socialLinks.facebook = facebook;
    if (instagram) socialLinks.instagram = instagram;
    if (twitter) socialLinks.twitter = twitter;
    if (linkedin) socialLinks.linkedin = linkedin;
    if (youtube) socialLinks.youtube = youtube;
    if (email) socialLinks.email = email;

    try {
      const response = await fetch('/builder/site/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          footer_text: footerText,
          social_links: socialLinks
        })
      });

      const data = await response.json();

      if (data.success) {
        // Republish to apply changes
        await publishAll();
        alert('Footer saved successfully!');
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      alert('Error saving footer: ' + error.message);
    }
  }
</script>
{% endblock %}
