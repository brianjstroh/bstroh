{% extends "base.html" %}

{% block title %}{{ site.site_name }} - Site Builder{% endblock %}

{% block content %}
<div class="row">
  <!-- Sidebar -->
  <div class="col-md-3">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-files"></i> Pages</span>
        <button class="btn btn-sm btn-outline-primary" onclick="showNewPageModal()">
          <i class="bi bi-plus"></i>
        </button>
      </div>
      <div class="list-group list-group-flush">
        {% for page in pages %}
        <a href="{{ url_for('builder_edit_page', page_id=page.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
          <span>
            <i class="bi bi-file-earmark-text"></i> {{ page.title }}
          </span>
          {% if page.id == 'index' %}
          <span class="badge bg-secondary">Home</span>
          {% endif %}
        </a>
        {% endfor %}
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card mb-4">
      <div class="card-header">
        <i class="bi bi-lightning"></i> Quick Actions
      </div>
      <div class="list-group list-group-flush">
        <a href="https://{{ domain }}" target="_blank" class="list-group-item list-group-item-action">
          <i class="bi bi-box-arrow-up-right"></i> View Live Site
        </a>
        <button class="list-group-item list-group-item-action" onclick="publishAll()">
          <i class="bi bi-cloud-upload"></i> Publish All Pages
        </button>
        <a href="{{ url_for('browse', prefix='') }}" class="list-group-item list-group-item-action text-muted">
          <i class="bi bi-folder"></i> File Manager
        </a>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="col-md-9">
    <!-- Site Settings Card -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-gear"></i> Site Settings</span>
        <button class="btn btn-sm btn-primary" onclick="saveSettings()">
          <i class="bi bi-check"></i> Save Changes
        </button>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Site Name</label>
              <input type="text" class="form-control" id="siteName" value="{{ site.site_name }}">
            </div>
            <div class="mb-3">
              <label class="form-label">Footer Text</label>
              <input type="text" class="form-control" id="footerText" value="{{ site.footer_text }}">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Color Scheme</label>
              <select class="form-select" id="colorScheme" onchange="onColorSchemeChange()">
                {% for scheme in color_schemes %}
                <option value="{{ scheme.id }}" {% if scheme.id == site.color_scheme_id %}selected{% endif %}>
                  {{ scheme.name }}
                </option>
                {% endfor %}
                <option value="custom" {% if site.color_scheme_id == 'custom' %}selected{% endif %}>Custom</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Logo</label>
              <div class="input-group">
                <input type="text" class="form-control" id="logoUrl" value="{{ site.logo_url }}" placeholder="Upload or paste URL">
                <input type="file" id="logoUpload" accept="image/*" style="display: none;" onchange="uploadLogo(this)">
                <button class="btn btn-outline-secondary" onclick="document.getElementById('logoUpload').click()">
                  <i class="bi bi-upload"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Custom Colors (shown only when "Custom" is selected) -->
        <div class="mt-4" id="customColorsSection" style="display: none;">
          <h6>Custom Colors</h6>
          <p class="text-muted small">Set your own colors for your site.</p>
          <div class="row row-cols-2 row-cols-md-4 g-2">
            <div class="col">
              <label class="form-label small">Primary</label>
              <input type="color" class="form-control form-control-color" id="colorPrimary"
                     value="{{ site.color_overrides.primary or '#0066cc' }}">
            </div>
            <div class="col">
              <label class="form-label small">Secondary</label>
              <input type="color" class="form-control form-control-color" id="colorSecondary"
                     value="{{ site.color_overrides.secondary or '#004499' }}">
            </div>
            <div class="col">
              <label class="form-label small">Accent</label>
              <input type="color" class="form-control form-control-color" id="colorAccent"
                     value="{{ site.color_overrides.accent or '#00ccff' }}">
            </div>
            <div class="col">
              <label class="form-label small">Background</label>
              <input type="color" class="form-control form-control-color" id="colorBackground"
                     value="{{ site.color_overrides.background or '#f8fafc' }}">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Preview -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-eye"></i> Site Preview</span>
        <div class="btn-group btn-group-sm">
          <button class="btn btn-outline-secondary active" onclick="setPreviewSize('desktop')">
            <i class="bi bi-display"></i>
          </button>
          <button class="btn btn-outline-secondary" onclick="setPreviewSize('tablet')">
            <i class="bi bi-tablet"></i>
          </button>
          <button class="btn btn-outline-secondary" onclick="setPreviewSize('mobile')">
            <i class="bi bi-phone"></i>
          </button>
        </div>
      </div>
      <div class="card-body p-0">
        <div id="previewContainer" style="background: #f0f0f0; padding: 1rem; overflow-x: auto;">
          <iframe id="previewFrame" src="{{ url_for('builder_preview', page_id='index') }}"
                  style="width: 100%; height: 500px; border: none; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
          </iframe>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Page Modal -->
<div class="modal fade" id="newPageModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Page</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Page Title</label>
          <input type="text" class="form-control" id="newPageTitle" placeholder="About Us">
        </div>
        <div class="mb-3">
          <label class="form-label">Page URL</label>
          <div class="input-group">
            <span class="input-group-text">{{ domain }}/</span>
            <input type="text" class="form-control" id="newPageSlug" placeholder="about">
            <span class="input-group-text">.html</span>
          </div>
          <div class="form-text">Leave blank to auto-generate from title.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="createPage()">Create Page</button>
      </div>
    </div>
  </div>
</div>

<script>
  let newPageModal;
  const colorSchemes = {{ color_schemes | tojson | safe }};

  document.addEventListener('DOMContentLoaded', function() {
    newPageModal = new bootstrap.Modal(document.getElementById('newPageModal'));

    // Auto-generate slug from title
    document.getElementById('newPageTitle').addEventListener('input', function() {
      const slug = this.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
      document.getElementById('newPageSlug').value = slug;
    });

    // Initialize custom colors visibility
    onColorSchemeChange();
  });

  function onColorSchemeChange() {
    const schemeId = document.getElementById('colorScheme').value;
    const customSection = document.getElementById('customColorsSection');

    if (schemeId === 'custom') {
      customSection.style.display = 'block';
    } else {
      customSection.style.display = 'none';
      // Pre-populate custom colors with selected scheme's colors (for if they switch to custom later)
      const scheme = colorSchemes.find(s => s.id === schemeId);
      if (scheme && scheme.colors) {
        document.getElementById('colorPrimary').value = scheme.colors.primary || '#0066cc';
        document.getElementById('colorSecondary').value = scheme.colors.secondary || '#004499';
        document.getElementById('colorAccent').value = scheme.colors.accent || '#00ccff';
        document.getElementById('colorBackground').value = scheme.colors.background || '#f8fafc';
      }
    }
  }

  function showNewPageModal() {
    document.getElementById('newPageTitle').value = '';
    document.getElementById('newPageSlug').value = '';
    newPageModal.show();
  }

  async function createPage() {
    const title = document.getElementById('newPageTitle').value.trim();
    const slug = document.getElementById('newPageSlug').value.trim();

    if (!title) {
      alert('Please enter a page title');
      return;
    }

    try {
      const response = await fetch('/builder/pages/new', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, page_id: slug || undefined })
      });

      const data = await response.json();

      if (data.success) {
        window.location.href = '/builder/pages/' + data.page.id;
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      alert('Error creating page: ' + error.message);
    }
  }

  async function saveSettings() {
    const schemeId = document.getElementById('colorScheme').value;
    const colorOverrides = {};

    // Only save custom colors if "Custom" scheme is selected
    if (schemeId === 'custom') {
      colorOverrides.primary = document.getElementById('colorPrimary').value;
      colorOverrides.secondary = document.getElementById('colorSecondary').value;
      colorOverrides.accent = document.getElementById('colorAccent').value;
      colorOverrides.background = document.getElementById('colorBackground').value;
    }

    try {
      const response = await fetch('/builder/site/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          site_name: document.getElementById('siteName').value,
          footer_text: document.getElementById('footerText').value,
          color_scheme_id: schemeId,
          logo_url: document.getElementById('logoUrl').value,
          color_overrides: colorOverrides
        })
      });

      const data = await response.json();

      if (data.success) {
        // Republish to apply changes
        await publishAll();
        document.getElementById('previewFrame').src = document.getElementById('previewFrame').src;
      } else {
        alert('Error: ' + data.error);
      }
    } catch (error) {
      alert('Error saving settings: ' + error.message);
    }
  }

  async function publishAll() {
    try {
      const response = await fetch('/builder/publish', { method: 'POST' });
      const data = await response.json();

      if (data.success) {
        // Refresh preview
        document.getElementById('previewFrame').src = document.getElementById('previewFrame').src;
      } else {
        alert('Error publishing: ' + data.error);
      }
    } catch (error) {
      alert('Error publishing: ' + error.message);
    }
  }

  async function uploadLogo(input) {
    if (!input.files || !input.files[0]) return;

    const formData = new FormData();
    formData.append('file', input.files[0]);

    try {
      const response = await fetch('/builder/assets/upload', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        document.getElementById('logoUrl').value = data.url;
      } else {
        alert('Error uploading: ' + data.error);
      }
    } catch (error) {
      alert('Error uploading: ' + error.message);
    }
  }

  function setPreviewSize(size) {
    const frame = document.getElementById('previewFrame');
    const container = document.getElementById('previewContainer');

    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.closest('.btn').classList.add('active');

    switch(size) {
      case 'mobile':
        frame.style.width = '375px';
        frame.style.margin = '0 auto';
        frame.style.display = 'block';
        break;
      case 'tablet':
        frame.style.width = '768px';
        frame.style.margin = '0 auto';
        frame.style.display = 'block';
        break;
      default:
        frame.style.width = '100%';
        frame.style.margin = '0';
    }
  }
</script>
{% endblock %}
