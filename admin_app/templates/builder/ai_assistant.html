{% extends "base.html" %}

{% block title %}AI Page Assistant - {{ site.site_name }}{% endblock %}

{% block content %}
<style>
  .ai-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    height: calc(100vh - 140px);
    min-height: 600px;
  }

  @media (max-width: 1200px) {
    .ai-container {
      grid-template-columns: 1fr;
      height: auto;
    }
  }

  .chat-panel {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    min-height: 300px;
  }

  .message {
    margin-bottom: 1rem;
    display: flex;
    gap: 0.75rem;
  }

  .message.user {
    flex-direction: row-reverse;
  }

  .message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 1rem;
  }

  .message.assistant .message-avatar {
    background: linear-gradient(135deg, var(--forest-medium), var(--forest-accent));
    color: white;
  }

  .message.user .message-avatar {
    background: var(--bark-medium);
    color: white;
  }

  .message-content {
    max-width: 85%;
    padding: 0.75rem 1rem;
    border-radius: 12px;
    line-height: 1.5;
  }

  .message.assistant .message-content {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px 12px 12px 2px;
  }

  .message.user .message-content {
    background: var(--forest-medium);
    color: white;
    border-radius: 12px 12px 2px 12px;
  }

  .message-content pre {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 0.75rem;
    border-radius: 6px;
    overflow-x: auto;
    font-size: 0.8rem;
    margin: 0.5rem 0;
  }

  .message-content code {
    font-family: 'Monaco', 'Consolas', monospace;
  }

  .message-meta {
    font-size: 0.75rem;
    color: #888;
    margin-top: 0.25rem;
  }

  .chat-input-container {
    margin-top: 1rem;
    display: flex;
    gap: 0.5rem;
  }

  .chat-input {
    flex: 1;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    border: 2px solid #e0e0e0;
    transition: border-color 0.2s;
    resize: none;
    min-height: 44px;
    max-height: 150px;
    overflow-y: auto;
    font-family: inherit;
    font-size: inherit;
    line-height: 1.4;
  }

  .chat-input:focus {
    border-color: var(--forest-accent);
    outline: none;
  }

  .chat-input-container {
    align-items: flex-end;
  }

  .send-btn {
    border-radius: 50%;
    width: 44px;
    height: 44px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .preview-panel {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .preview-frame-container {
    flex: 1;
    background: #f0f0f0;
    border-radius: 8px;
    overflow: hidden;
    min-height: 400px;
  }

  .preview-frame {
    width: 100%;
    height: 100%;
    border: none;
    background: white;
  }

  .typing-indicator {
    display: flex;
    gap: 4px;
    padding: 0.5rem 1rem;
    background: white;
    border-radius: 12px;
    border: 1px solid #e0e0e0;
    width: fit-content;
  }

  .typing-dot {
    width: 8px;
    height: 8px;
    background: var(--forest-medium);
    border-radius: 50%;
    animation: typing 1.4s infinite;
  }

  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
    30% { transform: translateY(-4px); opacity: 1; }
  }

  .action-buttons {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
  }

  .suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .suggestion-chip {
    padding: 0.4rem 0.8rem;
    background: white;
    border: 1px solid var(--forest-light);
    border-radius: 20px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--forest-dark);
  }

  .suggestion-chip:hover {
    background: var(--forest-accent);
    color: white;
    border-color: var(--forest-accent);
  }

  .empty-preview {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #888;
    text-align: center;
    padding: 2rem;
  }

  .empty-preview i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .generated-actions {
    padding: 1rem;
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 8px;
    margin-top: 0.5rem;
  }

  .page-info-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    background: white;
    border-radius: 8px;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .welcome-message {
    text-align: center;
    padding: 2rem;
    color: #666;
  }

  .welcome-message h4 {
    color: var(--forest-dark);
    margin-bottom: 1rem;
  }

  .welcome-message p {
    margin-bottom: 1.5rem;
  }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <a href="{{ url_for('builder_dashboard') }}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>
  <h4 class="mb-0"><i class="bi bi-robot"></i> AI Page Assistant</h4>
  <div>
    <button class="btn btn-outline-danger btn-sm" onclick="clearConversation()" title="Start new conversation">
      <i class="bi bi-trash"></i> Clear Chat
    </button>
  </div>
</div>

<!-- Settings Bar -->
<div class="page-info-bar">
  <div class="d-flex align-items-center gap-2">
    <label class="form-label mb-0 small fw-bold">Target Page:</label>
    <select id="pageSelector" class="form-select form-select-sm" style="width: auto;">
      <option value="">Create new page</option>
      {% for page in pages %}
      <option value="{{ page.id }}" {% if current_page and current_page.id == page.id %}selected{% endif %}>
        {{ page.title }}{% if page.id == 'index' %} (Home){% endif %}
      </option>
      {% endfor %}
    </select>
  </div>

  <div class="d-flex align-items-center gap-2">
    <span class="badge bg-secondary"><i class="bi bi-robot"></i> Powered by Claude 4.5 Haiku</span>
  </div>
</div>

<div class="ai-container">
  <!-- Chat Panel -->
  <div class="chat-panel">
    <div class="card flex-grow-1 d-flex flex-column">
      <div class="card-header py-2">
        <i class="bi bi-chat-dots"></i> Chat
        <span id="conversationLength" class="badge bg-secondary ms-2" style="display: none;">0 messages</span>
      </div>
      <div class="card-body p-0 d-flex flex-column flex-grow-1">
        <div class="chat-messages" id="chatMessages">
          <!-- Welcome message -->
          <div class="welcome-message" id="welcomeMessage">
            <h4><i class="bi bi-stars"></i> Welcome to AI Page Assistant</h4>
            <p>I can help you create professional web pages. Just describe what you want, and I'll generate the content and layout for you.</p>
            <div class="suggestions">
              <span class="suggestion-chip" onclick="sendSuggestion('Create a professional About Us page for a small business')">
                <i class="bi bi-building"></i> About Us page
              </span>
              <span class="suggestion-chip" onclick="sendSuggestion('Create a services page showcasing 3 main offerings with descriptions')">
                <i class="bi bi-briefcase"></i> Services page
              </span>
              <span class="suggestion-chip" onclick="sendSuggestion('Create a landing page for a product launch with hero section and features')">
                <i class="bi bi-rocket"></i> Landing page
              </span>
              <span class="suggestion-chip" onclick="sendSuggestion('Create a team page introducing 4 team members with photos and bios')">
                <i class="bi bi-people"></i> Team page
              </span>
            </div>
          </div>
        </div>

        <div class="p-3 border-top">
          <div class="chat-input-container">
            <textarea class="chat-input" id="chatInput" rows="1"
                      placeholder="Describe the page you want to create..."
                      onkeydown="handleInputKeydown(event)"
                      oninput="autoResizeTextarea(this)"></textarea>
            <button class="btn btn-primary send-btn" onclick="sendMessage()" id="sendBtn">
              <i class="bi bi-send"></i>
            </button>
          </div>
          <div class="mt-2 d-flex justify-content-between align-items-center">
            <small class="text-muted" id="usageInfo"></small>
            <small class="text-muted">Enter to send, Shift+Enter for new line</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Panel -->
  <div class="preview-panel">
    <div class="card flex-grow-1 d-flex flex-column">
      <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <span><i class="bi bi-eye"></i> Preview</span>
        <div class="d-flex gap-2">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-light btn-sm active" onclick="setPreviewSize('desktop')">
              <i class="bi bi-display"></i>
            </button>
            <button class="btn btn-outline-light btn-sm" onclick="setPreviewSize('tablet')">
              <i class="bi bi-tablet"></i>
            </button>
            <button class="btn btn-outline-light btn-sm" onclick="setPreviewSize('mobile')">
              <i class="bi bi-phone"></i>
            </button>
          </div>
          <button class="btn btn-outline-light btn-sm" onclick="popOutPreview()" title="Open in new window" id="popOutBtn" style="display: none;">
            <i class="bi bi-box-arrow-up-right"></i>
          </button>
        </div>
      </div>
      <div class="card-body p-0 flex-grow-1">
        <div class="preview-frame-container" id="previewContainer">
          <div class="empty-preview" id="emptyPreview">
            <i class="bi bi-layout-text-window"></i>
            <h5>Preview Area</h5>
            <p>Generated pages will appear here.<br>You can preview before applying changes.</p>
          </div>
          <iframe id="previewFrame" class="preview-frame" style="display: none;"></iframe>
        </div>
      </div>
      <!-- Action buttons shown when there's generated content -->
      <div class="card-footer" id="actionFooter" style="display: none;">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <span class="text-muted small" id="generatedPageTitle"></span>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="discardGenerated()">
              <i class="bi bi-x"></i> Discard
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="editInBuilder()">
              <i class="bi bi-pencil"></i> Edit in Builder
            </button>
            <button class="btn btn-success btn-sm" onclick="applyGenerated()">
              <i class="bi bi-check-lg"></i> Apply Changes
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let selectedModel = 'haiku';
let currentGeneratedData = null;
let currentPreviewHtml = null;
let totalCost = 0;

function handleInputKeydown(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendMessage();
  }
}

function autoResizeTextarea(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
}

function sendSuggestion(text) {
  const input = document.getElementById('chatInput');
  input.value = text;
  autoResizeTextarea(input);
  sendMessage();
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message) return;

  const pageId = document.getElementById('pageSelector').value;

  // Hide welcome message
  document.getElementById('welcomeMessage').style.display = 'none';

  // Add user message to chat
  addMessage('user', message);
  input.value = '';
  input.style.height = 'auto';  // Reset textarea height

  // Disable send button and show typing indicator
  const sendBtn = document.getElementById('sendBtn');
  sendBtn.disabled = true;
  showTypingIndicator();

  try {
    const response = await fetch('/builder/ai-assistant/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: message,
        model: selectedModel,
        page_id: pageId || null
      })
    });

    const data = await response.json();
    hideTypingIndicator();

    if (data.success) {
      // Add assistant message
      addMessage('assistant', data.message, data.usage);

      // Update usage info
      if (data.usage) {
        totalCost += data.usage.estimated_cost;
        document.getElementById('usageInfo').textContent =
          `${data.model} | Session cost: $${totalCost.toFixed(4)}`;
      }

      // Update conversation length
      if (data.conversation_length) {
        const badge = document.getElementById('conversationLength');
        badge.style.display = 'inline';
        badge.textContent = `${data.conversation_length} messages`;
      }

      // If there's parsed data with components, show preview
      if (data.parsed_data && data.parsed_data.components) {
        await showGeneratedPreview(data.parsed_data);
      } else if (data.message && data.message.includes('"components"')) {
        // JSON was in response but couldn't be parsed (likely truncated)
        addMessage('assistant', '⚠️ The response was too long and got cut off. Try asking for a simpler page or fewer components.');
      }
    } else {
      addMessage('assistant', `Error: ${data.error || 'Unknown error occurred'}`);
    }
  } catch (error) {
    hideTypingIndicator();
    addMessage('assistant', `Error: ${error.message}`);
  }

  sendBtn.disabled = false;
  input.focus();
}

function addMessage(role, content, usage = null) {
  const messagesContainer = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${role}`;

  const avatar = role === 'assistant' ? '<i class="bi bi-robot"></i>' : '<i class="bi bi-person"></i>';

  // Format content - strip JSON/code from display (they're parsed separately for preview)
  let formattedContent = content;
  // Remove ```json blocks entirely
  formattedContent = formattedContent.replace(/```json\s*[\s\S]*?\s*```/g, '');
  // Remove any other code blocks
  formattedContent = formattedContent.replace(/```[\s\S]*?```/g, '');
  // Remove raw JSON objects that look like page data (starts with { and contains "action" or "components")
  formattedContent = formattedContent.replace(/\{\s*"action"\s*:[\s\S]*?\}(?=\s*$|\s*\n\s*\n)/g, '');
  formattedContent = formattedContent.replace(/\{\s*"components"\s*:[\s\S]*?\}(?=\s*$|\s*\n\s*\n)/g, '');
  // Clean up any leftover "Here's the JSON" type phrases
  formattedContent = formattedContent.replace(/here'?s?\s*(the|your)?\s*(json|code|page data|configuration)[:\s]*/gi, '');
  // Clean up extra whitespace and line breaks
  formattedContent = formattedContent.replace(/\n{3,}/g, '\n\n').trim();
  // Convert newlines to br tags (but not inside pre tags)
  formattedContent = formattedContent.replace(/\n/g, '<br>');

  let metaHtml = '';
  if (usage && role === 'assistant') {
    metaHtml = `<div class="message-meta">
      ${usage.input_tokens + usage.output_tokens} tokens | $${usage.estimated_cost.toFixed(5)}
    </div>`;
  }

  messageDiv.innerHTML = `
    <div class="message-avatar">${avatar}</div>
    <div>
      <div class="message-content">${formattedContent}</div>
      ${metaHtml}
    </div>
  `;

  messagesContainer.appendChild(messageDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
  const messagesContainer = document.getElementById('chatMessages');
  const typingDiv = document.createElement('div');
  typingDiv.className = 'message assistant';
  typingDiv.id = 'typingIndicator';
  typingDiv.innerHTML = `
    <div class="message-avatar"><i class="bi bi-robot"></i></div>
    <div class="typing-indicator">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
  `;
  messagesContainer.appendChild(typingDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
  const indicator = document.getElementById('typingIndicator');
  if (indicator) indicator.remove();
}

async function showGeneratedPreview(parsedData) {
  currentGeneratedData = parsedData;

  // Prepare page data for preview
  const pageData = {
    id: 'preview',
    title: parsedData.page_title || 'AI Generated Page',
    slug: 'preview',
    meta_description: parsedData.meta_description || '',
    slots: {
      main: parsedData.components || []
    }
  };

  // Generate component IDs
  pageData.slots.main.forEach((comp, i) => {
    if (!comp.id) {
      const timestamp = new Date().toISOString().replace(/[^0-9]/g, '').substring(0, 14);
      comp.id = `${comp.type}-${timestamp}-${i}`;
    }
    if (!comp.data) comp.data = {};
    if (!comp.data.anchor_id) comp.data.anchor_id = comp.id;
  });

  try {
    const response = await fetch('/builder/ai-assistant/preview', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ page_data: pageData })
    });

    const data = await response.json();

    if (data.success) {
      const frame = document.getElementById('previewFrame');
      const empty = document.getElementById('emptyPreview');

      // Store HTML for pop-out
      currentPreviewHtml = data.html;

      frame.srcdoc = data.html;
      frame.style.display = 'block';
      empty.style.display = 'none';

      // Show action footer and pop-out button
      document.getElementById('actionFooter').style.display = 'block';
      document.getElementById('popOutBtn').style.display = 'inline-block';
      document.getElementById('generatedPageTitle').textContent =
        `"${parsedData.page_title || 'Untitled'}" - ${parsedData.components?.length || 0} components`;
    }
  } catch (error) {
    console.error('Preview error:', error);
  }
}

function setPreviewSize(size) {
  const frame = document.getElementById('previewFrame');
  const container = document.getElementById('previewContainer');

  document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
  event.target.closest('.btn').classList.add('active');

  switch(size) {
    case 'mobile':
      frame.style.width = '375px';
      frame.style.margin = '0 auto';
      frame.style.display = frame.style.display === 'none' ? 'none' : 'block';
      break;
    case 'tablet':
      frame.style.width = '768px';
      frame.style.margin = '0 auto';
      frame.style.display = frame.style.display === 'none' ? 'none' : 'block';
      break;
    default:
      frame.style.width = '100%';
      frame.style.margin = '0';
  }
}

function popOutPreview() {
  if (!currentPreviewHtml) return;

  const previewWindow = window.open('', '_blank', 'width=1200,height=800');
  if (previewWindow) {
    previewWindow.document.write(currentPreviewHtml);
    previewWindow.document.close();
  }
}

async function applyGenerated() {
  if (!currentGeneratedData) return;

  const pageId = document.getElementById('pageSelector').value;
  const createNew = !pageId;

  // Prepare page data
  const pageData = {
    id: pageId || 'new',
    title: currentGeneratedData.page_title || 'AI Generated Page',
    slug: pageId || 'new',
    meta_description: currentGeneratedData.meta_description || '',
    slots: {
      main: currentGeneratedData.components || []
    }
  };

  // Generate component IDs
  pageData.slots.main.forEach((comp, i) => {
    if (!comp.id) {
      const timestamp = new Date().toISOString().replace(/[^0-9]/g, '').substring(0, 14);
      comp.id = `${comp.type}-${timestamp}-${i}`;
    }
    if (!comp.data) comp.data = {};
    if (!comp.data.anchor_id) comp.data.anchor_id = comp.id;
  });

  try {
    const response = await fetch('/builder/ai-assistant/apply', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        page_id: pageId || null,
        page_data: pageData,
        create_new: createNew,
        new_page_title: currentGeneratedData.page_title || 'AI Generated Page',
        replace: true
      })
    });

    const data = await response.json();

    if (data.success) {
      // Show success message
      const action = data.created ? 'created' : 'updated';
      addMessage('assistant', `Page ${action} successfully! Redirecting to editor...`);

      // Redirect to page editor
      setTimeout(() => {
        window.location.href = `/builder/pages/${data.page_id}`;
      }, 1500);
    } else {
      addMessage('assistant', `Error applying changes: ${data.error}`);
    }
  } catch (error) {
    addMessage('assistant', `Error: ${error.message}`);
  }
}

function discardGenerated() {
  currentGeneratedData = null;
  currentPreviewHtml = null;
  document.getElementById('previewFrame').style.display = 'none';
  document.getElementById('emptyPreview').style.display = 'flex';
  document.getElementById('actionFooter').style.display = 'none';
  document.getElementById('popOutBtn').style.display = 'none';
  addMessage('assistant', 'Generated content discarded. Feel free to describe what you\'d like instead.');
}

function editInBuilder() {
  // For now, just apply and redirect
  applyGenerated();
}

async function clearConversation() {
  if (!confirm('Clear the conversation and start fresh?')) return;

  try {
    await fetch('/builder/ai-assistant/clear', { method: 'POST' });

    // Clear UI
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = `
      <div class="welcome-message" id="welcomeMessage">
        <h4><i class="bi bi-stars"></i> Welcome to AI Page Assistant</h4>
        <p>I can help you create professional web pages. Just describe what you want, and I'll generate the content and layout for you.</p>
        <div class="suggestions">
          <span class="suggestion-chip" onclick="sendSuggestion('Create a professional About Us page for a small business')">
            <i class="bi bi-building"></i> About Us page
          </span>
          <span class="suggestion-chip" onclick="sendSuggestion('Create a services page showcasing 3 main offerings with descriptions')">
            <i class="bi bi-briefcase"></i> Services page
          </span>
          <span class="suggestion-chip" onclick="sendSuggestion('Create a landing page for a product launch with hero section and features')">
            <i class="bi bi-rocket"></i> Landing page
          </span>
          <span class="suggestion-chip" onclick="sendSuggestion('Create a team page introducing 4 team members with photos and bios')">
            <i class="bi bi-people"></i> Team page
          </span>
        </div>
      </div>
    `;

    // Reset state
    currentGeneratedData = null;
    currentPreviewHtml = null;
    totalCost = 0;
    document.getElementById('usageInfo').textContent = '';
    document.getElementById('conversationLength').style.display = 'none';
    document.getElementById('previewFrame').style.display = 'none';
    document.getElementById('emptyPreview').style.display = 'flex';
    document.getElementById('actionFooter').style.display = 'none';
    document.getElementById('popOutBtn').style.display = 'none';

  } catch (error) {
    alert('Error clearing conversation: ' + error.message);
  }
}

// Focus input on load
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('chatInput').focus();
});
</script>
{% endblock %}
